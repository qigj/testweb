<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Example: Using a Named Query with PostgreSQL - SynxDB 2 Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SynxDB 2 Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <a href="https://www.synxdata.com/"><img id="fa fa-print" src="../SYNX-Text-and-Circular-Logo-142x28-White-text-Black-background.png" alt="Synx Data Labs Logo"/></a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="example-using-a-named-query-with-postgresql"><a class="header" href="#example-using-a-named-query-with-postgresql">‘Example: Using a Named Query with PostgreSQL’</a></h1>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<p>In this example, you:</p>
<ul>
<li>Use the PostgreSQL database <code>pgtestdb</code>, user <code>pxfuser1</code>, and PXF JDBC connector server configuration <code>pgsrvcfg</code> that you created in <a href="jdbc_pxf_postgresql.html">Example: Reading From and Writing to a PostgreSQL Database</a>.</li>
<li>Create two PostgreSQL tables and insert data into the tables.</li>
<li>Assign all privileges on the tables to <code>pxfuser1</code>.</li>
<li>Define a named query that performs a complex SQL statement on the two PostgreSQL tables, and add the query to the <code>pgsrvcfg</code> JDBC server configuration.</li>
<li>Create a PXF readable external table definition that matches the query result tuple and also specifies read partitioning options.</li>
<li>Read the query results, making use of PXF column projection and filter pushdown.</li>
</ul>
<h2 id="create-the-postgresql-tables-and-assign-permissions"><a class="header" href="#create-the-postgresql-tables-and-assign-permissions"><a id="nq_create_2pgtbl"></a>Create the PostgreSQL Tables and Assign Permissions</a></h2>
<p>Perform the following procedure to create PostgreSQL tables named <code>customers</code> and <code>orders</code> in the <code>public</code> schema of the database named <code>pgtestdb</code>, and grant the user named <code>pxfuser1</code> all privileges on these tables:</p>
<ol>
<li>
<p>Identify the host name and port of your PostgreSQL server.</p>
</li>
<li>
<p>Connect to the <code>pgtestdb</code> PostgreSQL database as the <code>postgres</code> user. For example, if your PostgreSQL server is running on the default port on the host named <code>pserver</code>:</p>
<pre><code class="language-shell">$ psql -U postgres -h pserver -d pgtestdb
</code></pre>
</li>
<li>
<p>Create a table named <code>customers</code> and insert some data into this table:</p>
<pre><code class="language-sql">CREATE TABLE customers(id int, name text, city text, state text);
INSERT INTO customers VALUES (111, 'Bill', 'Helena', 'MT');
INSERT INTO customers VALUES (222, 'Mary', 'Athens', 'OH');
INSERT INTO customers VALUES (333, 'Tom', 'Denver', 'CO');
INSERT INTO customers VALUES (444, 'Kate', 'Helena', 'MT');
INSERT INTO customers VALUES (555, 'Harry', 'Columbus', 'OH');
INSERT INTO customers VALUES (666, 'Kim', 'Denver', 'CO');
INSERT INTO customers VALUES (777, 'Erik', 'Missoula', 'MT');
INSERT INTO customers VALUES (888, 'Laura', 'Athens', 'OH');
INSERT INTO customers VALUES (999, 'Matt', 'Aurora', 'CO');
</code></pre>
</li>
<li>
<p>Create a table named <code>orders</code> and insert some data into this table:</p>
<pre><code class="language-sql">CREATE TABLE orders(customer_id int, amount int, month int, year int);
INSERT INTO orders VALUES (111, 12, 12, 2018);
INSERT INTO orders VALUES (222, 234, 11, 2018);
INSERT INTO orders VALUES (333, 34, 7, 2018);
INSERT INTO orders VALUES (444, 456, 111, 2018);
INSERT INTO orders VALUES (555, 56, 11, 2018);
INSERT INTO orders VALUES (666, 678, 12, 2018);
INSERT INTO orders VALUES (777, 12, 9, 2018);
INSERT INTO orders VALUES (888, 120, 10, 2018);
INSERT INTO orders VALUES (999, 120, 11, 2018);
</code></pre>
</li>
<li>
<p>Assign user <code>pxfuser1</code> all privileges on tables <code>customers</code> and <code>orders</code>, and then exit the <code>psql</code> subsystem:</p>
<pre><code class="language-sql">GRANT ALL ON customers TO pxfuser1;
GRANT ALL ON orders TO pxfuser1;
\q
</code></pre>
</li>
</ol>
<h2 id="configure-the-named-query"><a class="header" href="#configure-the-named-query"><a id="nq_jdbconfig"></a>Configure the Named Query</a></h2>
<p>In this procedure you create a named query text file, add it to the <code>pgsrvcfg</code> JDBC server configuration, and synchronize the PXF configuration to the SynxDB cluster.</p>
<p>This procedure will typically be performed by the SynxDB administrator.</p>
<ol>
<li>
<p>Log in to the SynxDB coordinator host:</p>
<pre><code class="language-shell">$ ssh gpadmin@&lt;coordinator&gt;
</code></pre>
</li>
<li>
<p>Navigate to the JDBC server configuration directory <code>pgsrvcfg</code>. For example:</p>
<pre><code class="language-shell">gpadmin@coordinator$ cd $PXF_BASE/servers/pgsrvcfg
</code></pre>
</li>
<li>
<p>Open a query text file named <code>pg_order_report.sql</code> in a text editor and copy/paste the following query into the file:</p>
<pre><code class="language-sql">SELECT c.name, c.city, sum(o.amount) AS total, o.month
  FROM customers c JOIN orders o ON c.id = o.customer_id
  WHERE c.state = 'CO'
GROUP BY c.name, c.city, o.month
</code></pre>
</li>
<li>
<p>Save the file and exit the editor.</p>
</li>
<li>
<p>Synchronize these changes to the PXF configuration to the SynxDB cluster:</p>
<pre><code class="language-shell">gpadmin@coordinator$ pxf cluster sync
</code></pre>
</li>
</ol>
<h2 id="read-the-query-results"><a class="header" href="#read-the-query-results"><a id="nq_readjdbc"></a>Read the Query Results</a></h2>
<p>Perform the following procedure on your SynxDB cluster to create a PXF external table that references the query file that you created in the previous section, and then reads the query result data:</p>
<ol>
<li>
<p>Create the PXF external table specifying the <code>jdbc</code> profile. For example:</p>
<pre><code class="language-sql">CREATE EXTERNAL TABLE pxf_queryres_frompg(name text, city text, total int, month int)
  LOCATION ('pxf://query:pg_order_report?PROFILE=jdbc&amp;SERVER=pgsrvcfg&amp;PARTITION_BY=month:int&amp;RANGE=1:13&amp;INTERVAL=3')
FORMAT 'CUSTOM' (FORMATTER='pxfwritable_import');
</code></pre>
<p>With this partitioning scheme, PXF will issue 4 queries to the remote SQL database, one query per quarter. Each query will return customer names and the total amount of all of their orders in a given month, aggregated per customer, per month, for each month of the target quarter. SynxDB will then combine the data into a single result set for you when you query the external table.</p>
</li>
<li>
<p>Display all rows of the query result:</p>
<pre><code class="language-sql">SELECT * FROM pxf_queryres_frompg ORDER BY city, total;

 name |  city  | total | month
------+--------+-------+-------
 Matt | Aurora |   120 |    11
 Tom  | Denver |    34 |     7
 Kim  | Denver |   678 |    12
(3 rows)
</code></pre>
</li>
<li>
<p>Use column projection to display the order total per city:</p>
<pre><code class="language-sql">SELECT city, sum(total) FROM pxf_queryres_frompg GROUP BY city;

  city  | sum
--------+-----
 Aurora | 120
 Denver | 712
(2 rows)
</code></pre>
<p>When you run this query, PXF requests and retrieves query results for only the <code>city</code> and <code>total</code> columns, reducing the amount of data sent back to SynxDB.</p>
</li>
<li>
<p>Provide additional filters and aggregations to filter the <code>total</code> in PostgreSQL:</p>
<pre><code class="language-sql">SELECT city, sum(total) FROM pxf_queryres_frompg
            WHERE total &gt; 100
            GROUP BY city;

  city  | sum
--------+-----
 Denver | 678
 Aurora | 120
(2 rows)
</code></pre>
<p>In this example, PXF will add the <code>WHERE</code> filter to the subquery. This filter is pushed to and run on the remote database system, reducing the amount of data that PXF sends back to SynxDB. The <code>GROUP BY</code> aggregation, however, is not pushed to the remote and is performed by SynxDB.</p>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../pxf/jdbc_pxf_trino.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../pxf/nfs_pxf.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../pxf/jdbc_pxf_trino.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../pxf/nfs_pxf.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
