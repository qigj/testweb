<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Memory and Threading - SynxDB 2 Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SynxDB 2 Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <a href="https://www.synxdata.com/"><img id="fa fa-print" src="../SYNX-Text-and-Circular-Logo-142x28-White-text-Black-background.png" alt="Synx Data Labs Logo"/></a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="memory-and-threading"><a class="header" href="#memory-and-threading">Memory and Threading</a></h1>
<p>Because a single PXF Service (JVM) serves multiple segments on a segment host, the PXF heap size can be a limiting runtime factor. This becomes more evident under concurrent workloads or with queries against large files. You may run into situations where a query hangs or fails due to insufficient memory or the Java garbage collector impacting response times. To avert or remedy these situations, first try increasing the Java maximum heap size or decreasing the Tomcat maximum number of threads, depending upon what works best for your system configuration. You may also choose to configure PXF to <a href="#pxf-cfgoom-autoterm">auto-terminate the server</a> (activated by default) or <a href="#pxf-cfgoom-heapdump">dump the Java heap</a> when it detects an out of memory condition.</p>
<h2 id="increasing-the-jvm-memory-for-pxf"><a class="header" href="#increasing-the-jvm-memory-for-pxf"><a id="pxf-heapcfg"></a>Increasing the JVM Memory for PXF</a></h2>
<p>Each PXF Service running on a SynxDB host is configured with a default maximum Java heap size of 2GB and an initial heap size of 1GB. If the hosts in your SynxDB cluster have an ample amount of memory, try increasing the maximum heap size to a value between 3-4GB. Set the initial and maximum heap size to the same value if possible.</p>
<p>Perform the following procedure to increase the heap size for the PXF Service running on each host in your SynxDB cluster.</p>
<ol>
<li>
<p>Log in to your SynxDB coordinator host:</p>
<pre><code class="language-shell">$ ssh gpadmin@&lt;coordinator&gt;
</code></pre>
</li>
<li>
<p>Edit the <code>$PXF_BASE/conf/pxf-env.sh</code> file. For example:</p>
<pre><code class="language-shell">gpadmin@coordinator$ vi $PXF_BASE/conf/pxf-env.sh
</code></pre>
</li>
<li>
<p>Locate the <code>PXF_JVM_OPTS</code> setting in the <code>pxf-env.sh</code> file, and update the <code>-Xmx</code> and/or <code>-Xms</code> options to the desired value. For example:</p>
<pre><code class="language-shell">PXF_JVM_OPTS="-Xmx3g -Xms3g"
</code></pre>
</li>
<li>
<p>Save the file and exit the editor.</p>
</li>
<li>
<p>Use the <code>pxf cluster sync</code> command to copy the updated <code>pxf-env.sh</code> file to the SynxDB cluster. For example:</p>
<pre><code class="language-shell">gpadmin@coordinator$ pxf cluster sync
</code></pre>
</li>
<li>
<p>Restart PXF on each SynxDB host as described in <a href="cfginitstart_pxf.html#restart_pxf">Restarting PXF</a>.</p>
</li>
</ol>
<h2 id="configuring-out-of-memory-condition-actions"><a class="header" href="#configuring-out-of-memory-condition-actions"><a id="pxf-cfgoom"></a>Configuring Out of Memory Condition Actions</a></h2>
<p>In an out of memory (OOM) situation, PXF returns the following error in response to a query:</p>
<pre><code class="language-pre">java.lang.OutOfMemoryError: Java heap space
</code></pre>
<p>You can configure the PXF JVM to activate/deactivate the following actions when it detects an OOM condition:</p>
<ul>
<li>Auto-terminate the PXF Service (activated by default).</li>
<li>Dump the Java heap (deactivated by default).</li>
</ul>
<h3 id="auto-terminating-the-pxf-server"><a class="header" href="#auto-terminating-the-pxf-server"><a id="pxf-cfgoom-autoterm"></a>Auto-Terminating the PXF Server</a></h3>
<p>By default, PXF is configured such that when the PXF JVM detects an out of memory condition on a SynxDB host, it automatically runs a script that terminates the PXF Service running on the host. The <code>PXF_OOM_KILL</code> environment variable in the <code>$PXF_BASE/conf/pxf-env.sh</code> configuration file governs this auto-terminate behavior.</p>
<p>When auto-terminate is activated and the PXF JVM detects an OOM condition and terminates the PXF Service on the host:</p>
<ul>
<li>
<p>PXF logs the following messages to <code>$PXF_LOGDIR/pxf-oom.log</code> on the segment host:</p>
<pre><code class="language-shell">=====&gt; &lt;date&gt; PXF Out of memory detected &lt;======
=====&gt; &lt;date&gt; PXF shutdown scheduled &lt;======
=====&gt; &lt;date&gt; Stopping PXF &lt;======
</code></pre>
</li>
<li>
<p>Any query that you run on a PXF external table will fail with the following error until you restart the PXF Service on the host:</p>
<pre><code class="language-shell">... Failed to connect to &lt;host&gt; port 5888: Connection refused
</code></pre>
</li>
</ul>
<p><strong>When the PXF Service on a host is shut down in this manner, you must explicitly restart the PXF Service on the host.</strong> See the <a href="ref/pxf.html">pxf</a> reference page for more information on the <code>pxf start</code> command.</p>
<p>Refer to the configuration <a href="#pxf-cfgoom_proc">procedure</a> below for the instructions to deactivate/activate this PXF configuration property.</p>
<h3 id="dumping-the-java-heap"><a class="header" href="#dumping-the-java-heap"><a id="pxf-cfgoom-heapdump"></a>Dumping the Java Heap</a></h3>
<p>In an out of memory situation, it may be useful to capture the Java heap dump to help determine what factors contributed to the resource exhaustion. You can configure PXF to write the heap dump to a file when it detects an OOM condition by setting the <code>PXF_OOM_DUMP_PATH</code> environment variable in the <code>$PXF_BASE/conf/pxf-env.sh</code> configuration file. By default, PXF does not dump the Java heap on OOM.</p>
<p>If you choose to activate the heap dump on OOM, you must set <code>PXF_OOM_DUMP_PATH</code> to the absolute path to a file or directory:</p>
<ul>
<li>If you specify a directory, the PXF JVM writes the heap dump to the file <code>&lt;directory&gt;/java_pid&lt;pid&gt;.hprof</code>, where <code>&lt;pid&gt;</code> identifies the process ID of the PXF Service instance. The PXF JVM writes a new file to the directory every time the JVM goes OOM.</li>
<li>If you specify a file and the file does not exist, the PXF JVM writes the heap dump to the file when it detects an OOM. If the file already exists, the JVM will not dump the heap.</li>
</ul>
<p>Ensure that the <code>gpadmin</code> user has write access to the dump file or directory.</p>
<p><strong>Note</strong>: Heap dump files are often rather large. If you activate heap dump on OOM for PXF and specify a directory for <code>PXF_OOM_DUMP_PATH</code>, multiple OOMs will generate multiple files in the directory and could potentially consume a large amount of disk space. If you specify a file for <code>PXF_OOM_DUMP_PATH</code>, disk usage is constant when the file name does not change. You must rename the dump file or configure a different <code>PXF_OOM_DUMP_PATH</code> to generate subsequent heap dumps.</p>
<p>Refer to the configuration <a href="#pxf-cfgoom_proc">procedure</a> below for the instructions to activate/deactivate this PXF configuration property.</p>
<h4 id="procedure"><a class="header" href="#procedure"><a id="pxf-cfgoom_proc"></a>Procedure</a></h4>
<p>Auto-termination of the PXF Service on OOM is deactivated by default. Heap dump generation on OOM is deactivated by default. To configure one or both of these properties, perform the following procedure:</p>
<ol>
<li>
<p>Log in to your SynxDB coordinator host:</p>
<pre><code class="language-shell">$ ssh gpadmin@&lt;coordinator&gt;
</code></pre>
</li>
<li>
<p>Edit the <code>$PXF_BASE/conf/pxf-env.sh</code> file. For example:</p>
<pre><code class="language-shell">gpadmin@coordinator$ vi $PXF_BASE/conf/pxf-env.sh
</code></pre>
</li>
<li>
<p>If you want to configure (i.e. turn off, or turn back on) auto-termination of the PXF Service on OOM, locate the <code>PXF_OOM_KILL</code> property in the <code>pxf-env.sh</code> file. If the setting is commented out, uncomment it, and then update the value. For example, to turn off this behavior, set the value to <code>false</code>:</p>
<pre><code class="language-shell">export PXF_OOM_KILL=false
</code></pre>
</li>
<li>
<p>If you want to configure (i.e. turn on, or turn back off) automatic heap dumping when the PXF Service hits an OOM condition, locate the <code>PXF_OOM_DUMP_PATH</code> setting in the <code>pxf-env.sh</code> file.</p>
<ol>
<li>
<p>To turn this behavior on, set the <code>PXF_OOM_DUMP_PATH</code> property value to the file system location to which you want the PXF JVM to dump the Java heap. For example, to dump to a file named <code>/home/gpadmin/pxfoom_segh1</code>:</p>
<pre><code class="language-shell">export PXF_OOM_DUMP_PATH=/home/pxfoom_segh1
</code></pre>
</li>
<li>
<p>To turn off heap dumping after you have turned it on, comment out the <code>PXF_OOM_DUMP_PATH</code> property setting:</p>
<pre><code class="language-shell">#export PXF_OOM_DUMP_PATH=/home/pxfoom_segh1
</code></pre>
</li>
</ol>
</li>
<li>
<p>Save the <code>pxf-env.sh</code> file and exit the editor.</p>
</li>
<li>
<p>Use the <code>pxf cluster sync</code> command to copy the updated <code>pxf-env.sh</code> file to the SynxDB cluster. For example:</p>
<pre><code class="language-shell">gpadmin@coordinator$ pxf cluster sync
</code></pre>
</li>
<li>
<p>Restart PXF on each SynxDB host as described in <a href="cfginitstart_pxf.html#restart_pxf">Restarting PXF</a>.</p>
</li>
</ol>
<h2 id="another-option-for-resource-constrained-pxf-segment-hosts"><a class="header" href="#another-option-for-resource-constrained-pxf-segment-hosts"><a id="pxf-threadcfg"></a>Another Option for Resource-Constrained PXF Segment Hosts</a></h2>
<p>If increasing the maximum heap size is not suitable for your SynxDB deployment, try decreasing the number of concurrent working threads configured for PXF’s embedded Tomcat web server. A decrease in the number of running threads will prevent any PXF server from exhausting its memory, while ensuring that current queries run to completion (albeit a bit slower). Tomcat’s default behavior is to queue requests until a thread is free, or the queue is exhausted.</p>
<p>The default maximum number of Tomcat threads for PXF is 200. The <code>pxf.max.threads</code> property in the <code>pxf-application.properties</code> configuration file controls this setting.</p>
<p>If you plan to run large workloads on a large number of files in an external Hive data store, or you are reading compressed ORC or Parquet data, consider specifying a lower <code>pxf.max.threads</code> value. Large workloads require more memory, and a lower thread count limits concurrency, and hence, memory consumption.</p>
<p><strong>Note</strong>: Keep in mind that an increase in the thread count correlates with an increase in memory consumption.</p>
<p>Perform the following procedure to set the maximum number of Tomcat threads for the PXF Service running on each host in your SynxDB deployment.</p>
<ol>
<li>
<p>Log in to your SynxDB coordinator host:</p>
<pre><code class="language-shell">$ ssh gpadmin@&lt;coordinator&gt;
</code></pre>
</li>
<li>
<p>Edit the <code>$PXF_BASE/conf/pxf-application.properties</code> file. For example:</p>
<pre><code class="language-shell">gpadmin@coordinator$ vi $PXF_BASE/conf/pxf-application.properties
</code></pre>
</li>
<li>
<p>Locate the <code>pxf.max.threads</code> setting in the <code>pxf-application.properties</code> file. If the setting is commented out, uncomment it, and then update to the desired value. For example, to reduce the maximum number of Tomcat threads to 100:</p>
<pre><code class="language-shell">pxf.max.threads=100
</code></pre>
</li>
<li>
<p>Save the file and exit the editor.</p>
</li>
<li>
<p>Use the <code>pxf cluster sync</code> command to copy the updated <code>pxf-application.properties</code> file to the SynxDB cluster. For example:</p>
<pre><code class="language-shell">gpadmin@coordinator$ pxf cluster sync
</code></pre>
</li>
<li>
<p>Restart PXF on each SynxDB host as described in <a href="cfginitstart_pxf.html#restart_pxf">Restarting PXF</a>.</p>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../pxf/cfg_logging.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../pxf/access_hdfs.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../pxf/cfg_logging.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../pxf/access_hdfs.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
