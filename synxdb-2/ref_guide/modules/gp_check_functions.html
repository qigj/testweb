<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>gp_check_functions - SynxDB 2 Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SynxDB 2 Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <a href="https://www.synxdata.com/"><img id="fa fa-print" src="../../SYNX-Text-and-Circular-Logo-142x28-White-text-Black-background.png" alt="Synx Data Labs Logo"/></a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="gp_check_functions"><a class="header" href="#gp_check_functions">gp_check_functions</a></h1>
<p>The <code>gp_check_functions</code> module implements views that identify missing and orphaned relation files. The module also exposes a user-defined function that you can use to move orphaned files.</p>
<p>The <code>gp_check_functions</code> module is a SynxDB extension.</p>
<h2 id="installing-and-registering-the-module"><a class="header" href="#installing-and-registering-the-module"><a id="topic_reg"></a>Installing and Registering the Module</a></h2>
<p>The <code>gp_check_functions</code> module is installed when you install SynxDB. Before you can use the views defined in the module, you must register the <code>gp_check_functions</code> extension in each database in which you want to use the views:
o</p>
<pre><code>CREATE EXTENSION gp_check_functions;
</code></pre>
<p>Refer to <a href="../../install_guide/install_modules.html">Installing Additional Supplied Modules</a> for more information.</p>
<h2 id="checking-for-missing-and-orphaned-data-files"><a class="header" href="#checking-for-missing-and-orphaned-data-files"><a id="missingfiles"></a>Checking for Missing and Orphaned Data Files</a></h2>
<p>SynxDB considers a relation data file that is present in the catalog, but not on disk, to be missing. Conversely, when SynxDB encounters an unexpected data file on disk that is not referenced in any relation, it considers that file to be orphaned.</p>
<p>SynxDB provides the following views to help identify if missing or orphaned files exist in the current database:</p>
<ul>
<li><a href="#orphaned">gp_check_orphaned_files</a></li>
<li><a href="#missing">gp_check_missing_files</a></li>
<li><a href="#missing_ext">gp_check_missing_files_ext</a></li>
</ul>
<p>Consider it a best practice to check for these conditions prior to expanding the cluster or before offline maintenance.</p>
<p>By default, the views in this module are available to <code>PUBLIC</code>.</p>
<h3 id="gp_check_orphaned_files"><a class="header" href="#gp_check_orphaned_files"><a id="orphaned"></a>gp_check_orphaned_files</a></h3>
<p>The <code>gp_check_orphaned_files</code> view scans the default and user-defined tablespaces for orphaned data files. SynxDB considers normal data files, files with an underscore (<code>_</code>) in the name, and extended numbered files (files that contain a <code>.&lt;N&gt;</code> in the name) in this check. <code>gp_check_orphaned_files</code> gathers results from the SynxDB master and all segments.</p>
<div class="table-wrapper"><table><thead><tr><th>Column</th><th>Description</th></tr></thead><tbody>
<tr><td>gp_segment_id</td><td>The SynxDB segment identifier.</td></tr>
<tr><td>tablespace</td><td>The identifier of the tablespace in which the orphaned file resides.</td></tr>
<tr><td>filename</td><td>The file name of the orphaned data file.</td></tr>
<tr><td>filepath</td><td>The file system path of the orphaned data file, relative to the data directory of the master or segment.</td></tr>
</tbody></table>
</div>
<blockquote>
<p><strong>Caution</strong> Use this view as one of many data points to identify orphaned data files. Do not delete files based solely on results from querying this view.</p>
</blockquote>
<h3 id="gp_check_missing_files"><a class="header" href="#gp_check_missing_files"><a id="missing"></a>gp_check_missing_files</a></h3>
<p>The <code>gp_check_missing_files</code> view scans heap and append-optimized, column-oriented tables for missing data files. SynxDB considers only normal data files (files that do not contain a <code>.</code> or an <code>_</code> in the name) in this check. <code>gp_check_missing_files</code> gathers results from the SynxDB master and all segments.</p>
<div class="table-wrapper"><table><thead><tr><th>Column</th><th>Description</th></tr></thead><tbody>
<tr><td>gp_segment_id</td><td>The SynxDB segment identifier.</td></tr>
<tr><td>tablespace</td><td>The identifier of the tablespace in which the table resides.</td></tr>
<tr><td>relname</td><td>The name of the table that has a missing data file(s).</td></tr>
<tr><td>filename</td><td>The file name of the missing data file.</td></tr>
</tbody></table>
</div>
<h3 id="gp_check_missing_files_ext"><a class="header" href="#gp_check_missing_files_ext"><a id="missing_ext"></a>gp_check_missing_files_ext</a></h3>
<p>The <code>gp_check_missing_files_ext</code> view scans only append-optimized, column-oriented tables for missing extended data files. SynxDB considers both normal data files and extended numbered files (files that contain a <code>.&lt;N&gt;</code> in the name) in this check. Files that contain an <code>_</code> in the name, and <code>.fsm</code>, <code>.vm</code>, and other supporting files, are not considered. <code>gp_check_missing_files_ext</code> gathers results from the SynxDB segments only.</p>
<div class="table-wrapper"><table><thead><tr><th>Column</th><th>Description</th></tr></thead><tbody>
<tr><td>gp_segment_id</td><td>The SynxDB segment identifier.</td></tr>
<tr><td>tablespace</td><td>The identifier of the tablespace in which the table resides.</td></tr>
<tr><td>relname</td><td>The name of the table that has a missing extended data file(s).</td></tr>
<tr><td>filename</td><td>The file name of the missing extended data file.</td></tr>
</tbody></table>
</div>
<h2 id="moving-orphaned-data-files"><a class="header" href="#moving-orphaned-data-files"><a id="moveorphanfiles"></a>Moving Orphaned Data Files</a></h2>
<p>The <code>gp_move_orphaned_files()</code> user-defined function (UDF) moves orphaned files found by the <a href="#orphaned">gp_check_orphaned_files</a> view into a file system location that you specify.</p>
<p>The function signature is: <code>gp_move_orphaned_files( &lt;target_directory&gt; TEXT )</code>.</p>
<p><code>&lt;target_directory&gt;</code> must exist on all segment hosts before you move the files, and the specified directory must be accessible by the <code>gpadmin</code> user. If you specify a relative path for <code>&lt;target_directory&gt;</code>, it is considered relative to the data directory of the master or segment.</p>
<p>SynxDB renames each moved data file to one that reflects the original location of the file in the data directory. The file name format differs depending on the tablespace in which the orphaned file resides:</p>
<div class="table-wrapper"><table><thead><tr><th>Tablespace</th><th>Renamed File Format</th></tr></thead><tbody>
<tr><td>default</td><td><code>seg&lt;num&gt;_base_&lt;database-oid&gt;_&lt;relfilenode&gt;</code></td></tr>
<tr><td>global</td><td><code>seg&lt;num&gt;_global_&lt;relfilenode&gt;</code></td></tr>
<tr><td>user-defined</td><td><code>seg&lt;num&gt;_pg_tblspc_&lt;tablespace-oid&gt;_&lt;gpdb-version&gt;_&lt;database-oid&gt;_&lt;relfilenode&gt;</code></td></tr>
</tbody></table>
</div>
<p>For example, if a file named <code>12345</code> in the default tablespace is orphaned on primary segment 2,</p>
<pre><code>SELECT * FROM gp_move_orphaned_files('/home/gpadmin/orphaned');
</code></pre>
<p>moves and renames the file as follows:</p>
<div class="table-wrapper"><table><thead><tr><th>Original Location</th><th>New Location and File Name</th></tr></thead><tbody>
<tr><td><code>&lt;data_directory&gt;/base/13700/12345</code></td><td><code>/home/gpadmin/orphaned/seg2_base_13700_12345</code></td></tr>
</tbody></table>
</div>
<p><code>gp_move_orphaned_files()</code> returns both the original and the new file system locations for each file that it moves, and also provides an indication of the success or failure of the move operation.</p>
<p>Once you move the orphaned files, you may choose to remove them or to back them up.</p>
<h2 id="examples"><a class="header" href="#examples"><a id="examples"></a>Examples</a></h2>
<p>Check for missing and orphaned non-extended files:</p>
<pre><code class="language-sql">SELECT * FROM gp_check_missing_files;
SELECT * FROM gp_check_orphaned_files;
</code></pre>
<p>Check for missing extended data files for append-optimized, column-oriented tables:</p>
<pre><code class="language-sql">SELECT * FROM gp_check_missing_files_ext;
</code></pre>
<p>Move orphaned files to the <code>/home/gpadmin/orphaned</code> directory:</p>
<pre><code class="language-sql">SELECT * FROM gp_move_orphaned_files('/home/gpadmin/orphaned');
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../ref_guide/modules/gp_array_agg.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../ref_guide/modules/gp_legacy_string_agg.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../ref_guide/modules/gp_array_agg.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../ref_guide/modules/gp_legacy_string_agg.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
