<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Backup/Restore Storage Plugin API - SynxDB 2 Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SynxDB 2 Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <a href="https://www.synxdata.com/"><img id="fa fa-print" src="../../SYNX-Text-and-Circular-Logo-142x28-White-text-Black-background.png" alt="Synx Data Labs Logo"/></a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="backuprestore-storage-plugin-api"><a class="header" href="#backuprestore-storage-plugin-api">Backup/Restore Storage Plugin API</a></h1>
<p>This topic describes how to develop a custom storage plugin with the SynxDB Backup/Restore Storage Plugin API.</p>
<p>The Backup/Restore Storage Plugin API provides a framework that you can use to develop and integrate a custom backup storage system with the SynxDB <a href="../../utility_guide/ref/gpbackup.html"><code>gpbackup</code></a> and <a href="../../utility_guide/ref/gprestore.html"><code>gprestore</code></a> utilities.</p>
<p>The Backup/Restore Storage Plugin API defines a set of interfaces that a plugin must support. The API also specifies the format and content of a configuration file for a plugin.</p>
<p>When you use the Backup/Restore Storage Plugin API, you create a plugin that the SynxDB administrator deploys to the SynxDB cluster. Once deployed, the plugin is available for use in certain backup and restore operations.</p>
<p>This topic includes the following subtopics:</p>
<ul>
<li><a href="#topic9339">Plugin Configuration File</a></li>
<li><a href="#topic_api">Plugin API</a></li>
<li><a href="#topic_commands">Plugin Commands</a></li>
<li><a href="#topic9337">Implementing a Backup/Restore Storage Plugin</a></li>
<li><a href="#topic9339a">Verifying a Backup/Restore Storage Plugin</a></li>
<li><a href="#topic9339b">Packaging and Deploying a Backup/Restore Storage Plugin</a></li>
</ul>
<h2 id="plugin-configuration-file"><a class="header" href="#plugin-configuration-file"><a id="topic9339"></a>Plugin Configuration File</a></h2>
<p>Specifying the <code>--plugin-config</code> option to the <code>gpbackup</code> and <code>gprestore</code> commands instructs the utilities to use the plugin specified in the configuration file for the operation.</p>
<p>The plugin configuration file provides information for both SynxDB and the plugin. The Backup/Restore Storage Plugin API defines the format of, and certain keywords used in, the plugin configuration file.</p>
<p>A plugin configuration file is a YAML file in the following format:</p>
<pre><code>executablepath: &lt;path_to_plugin_executable&gt;
options:
  &lt;keyword1&gt;: &lt;value1&gt;
  &lt;keyword2&gt;: &lt;value2&gt;
  ...
  &lt;keywordN&gt;: &lt;valueN&gt;
</code></pre>
<p><code>gpbackup</code> and <code>gprestore</code> use the <code>**executablepath**</code> value to determine the file system location of the plugin executable program.</p>
<p>The plugin configuration file may also include keywords and values specific to a plugin instance. A backup/restore storage plugin can use the <code>**options**</code> block specified in the file to obtain information from the user that may be required to perform its tasks. This information may include location, connection, or authentication information, for example. The plugin should both specify and consume the content of this information in <code>keyword:value</code> syntax.</p>
<p>A sample plugin configuration file for the SynxDB S3 backup/restore storage plugin follows:</p>
<pre><code>executablepath: $GPHOME/bin/gpbackup_s3_plugin
options:
  region: us-west-2
  aws_access_key_id: notarealID
  aws_secret_access_key: notarealkey
  bucket: gp_backup_bucket
  folder: synxdb_backups
</code></pre>
<h2 id="plugin-api"><a class="header" href="#plugin-api"><a id="topic_api"></a>Plugin API</a></h2>
<p>The plugin that you implement when you use the Backup/Restore Storage Plugin API is an executable program that supports specific commands invoked by <code>gpbackup</code> and <code>gprestore</code> at defined points in their respective life cycle operations:</p>
<ul>
<li>
<p>The SynxDB Backup/Restore Storage Plugin API provides hooks into the <code>gpbackup</code> lifecycle at initialization, during backup, and at cleanup/exit time.</p>
</li>
<li>
<p>The API provides hooks into the <code>gprestore</code> lifecycle at initialization, during restore, and at cleanup/exit time.</p>
</li>
<li>
<p>The API provides arguments that specify the execution scope (master host, segment host, or segment instance) for a plugin setup or cleanup command. The scope can be one of these values.</p>
<ul>
<li><code>master</code> - Run the plugin once on the master host.</li>
<li><code>segment_host</code> - Run the plugin once on each of the segment hosts.</li>
<li><code>segment</code> - Run the plugin once for each active segment instance on the host running the segment instance.
The SynxDB hosts and segment instances are based on the SynxDB configuration when the back up started. The values <code>segment_host</code> and <code>segment</code> are provided as a segment host can host multiple segment instances. There might be some setup or cleanup required at the segment host level as compared to each segment instance.</li>
</ul>
</li>
</ul>
<p>The Backup/Restore Storage Plugin API defines the following call syntax for a backup/restore storage plugin executable program:</p>
<pre><code>plugin_executable command config_file args
</code></pre>
<p>where:</p>
<ul>
<li><code>plugin_executable</code> - The absolute path of the backup/restore storage plugin executable program. This path is determined by the <code>executablepath</code> property value configured in the plugin’s configuration YAML file.</li>
<li><code>command</code> - The name of a Backup/Restore Storage Plugin API command that identifies a specific entry point to a <code>gpbackup</code> or <code>gprestore</code> lifecycle operation.</li>
<li><code>config_file</code> - The absolute path of the plugin’s configuration YAML file.</li>
<li><code>args</code> - The command arguments; the actual arguments differ depending upon the <code>command</code> specified.</li>
</ul>
<h3 id="plugin-commands"><a class="header" href="#plugin-commands"><a id="topic_commands"></a>Plugin Commands</a></h3>
<p>The SynxDB Backup/Restore Storage Plugin API defines the following commands:</p>
<div class="table-wrapper"><table><thead><tr><th>Command Name</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="plugin_api/plugin_api_version.html">plugin_api_version</a></td><td>Return the version of the Backup/Restore Storage Plugin API supported by the plugin. The currently supported version is 0.4.0.</td></tr>
<tr><td><a href="plugin_api/setup_plugin_for_backup.html">setup_plugin_for_backup</a></td><td>Initialize the plugin for a backup operation.</td></tr>
<tr><td><a href="plugin_api/backup_file.html">backup_file</a></td><td>Move a backup file to the remote storage system.</td></tr>
<tr><td><a href="plugin_api/backup_data.html">backup_data</a></td><td>Move streaming data from <code>stdin</code> to a file on the remote storage system.</td></tr>
<tr><td><a href="plugin_api/delete_backup.html">delete_backup</a></td><td>Delete the directory specified by the given backup timestamp on the remote system.</td></tr>
<tr><td><a href="plugin_api/cleanup_plugin_for_backup.html">cleanup_plugin_for_backup</a></td><td>Clean up after a backup operation.</td></tr>
<tr><td><a href="plugin_api/setup_plugin_for_restore.html">setup_plugin_for_restore</a></td><td>Initialize the plugin for a restore operation.</td></tr>
<tr><td><a href="plugin_api/restore_file.html">restore_file</a></td><td>Move a backup file from the remote storage system to a designated location on the local host.</td></tr>
<tr><td><a href="plugin_api/restore_data.html">restore_data</a></td><td>Move a backup file from the remote storage system, streaming the data to <code>stdout</code>.</td></tr>
<tr><td><a href="plugin_api/cleanup_plugin_for_restore.html">cleanup_plugin_for_restore</a></td><td>Clean up after a restore operation.</td></tr>
</tbody></table>
</div>
<p>A backup/restore storage plugin must support every command identified above, even if it is a no-op.</p>
<h2 id="implementing-a-backuprestore-storage-plugin"><a class="header" href="#implementing-a-backuprestore-storage-plugin"><a id="topic9337"></a>Implementing a Backup/Restore Storage Plugin</a></h2>
<p>You can implement a backup/restore storage plugin executable in any programming or scripting language.</p>
<p>The tasks performed by a backup/restore storage plugin will be very specific to the remote storage system. As you design the plugin implementation, you will want to:</p>
<ul>
<li>Examine the connection and data transfer interface to the remote storage system.</li>
<li>Identify the storage path specifics of the remote system.</li>
<li>Identify configuration information required from the user.</li>
<li>Define the keywords and value syntax for information required in the plugin configuration file.</li>
<li>Determine if, and how, the plugin will modify (compress, etc.) the data en route to/from the remote storage system.</li>
<li>Define a mapping between a <code>gpbackup</code> file path and the remote storage system.</li>
<li>Identify how <code>gpbackup</code> options affect the plugin, as well as which are required and/or not applicable. For example, if the plugin performs its own compression, <code>gpbackup</code> must be invoked with the <code>--no-compression</code> option to prevent the utility from compressing the data.</li>
</ul>
<p>A backup/restore storage plugin that you implement must:</p>
<ul>
<li>Support all plugin commands identified in <a href="#topic_commands">Plugin Commands</a>. Each command must exit with the values identified on the command reference page.</li>
</ul>
<p>Refer to the <a href="https://github.com/apache/cloudberry-gpbackup-s3-plugin">gpbackup-s3-plugin</a> github repository for an example plugin implementation.</p>
<h2 id="verifying-a-backuprestore-storage-plugin"><a class="header" href="#verifying-a-backuprestore-storage-plugin"><a id="topic9339a"></a>Verifying a Backup/Restore Storage Plugin</a></h2>
<p>The Backup/Restore Storage Plugin API includes a test bench that you can run to ensure that a plugin is well integrated with <code>gpbackup</code> and <code>gprestore</code>.</p>
<p>The test bench is a <code>bash</code> script that you run in a SynxDB installation. The script generates a small (&lt;1MB) data set in a SynxDB table, explicitly tests each command, and runs a backup and restore of the data (file and streaming). The test bench invokes <code>gpbackup</code> and <code>gprestore</code>, which in turn individually call/test each Backup/Restore Storage Plugin API command implemented in the plugin.</p>
<p>The test bench program calling syntax is:</p>
<pre><code>plugin_test_bench.sh &lt;plugin_executable plugin_config&gt;
</code></pre>
<h3 id="procedure"><a class="header" href="#procedure"><a id="topic8339191"></a>Procedure</a></h3>
<p>To run the Backup/Restore Storage Plugin API test bench against a plugin:</p>
<ol>
<li>
<p>Log in to the SynxDB master host and set up your environment. For example:</p>
<pre><code>$ ssh gpadmin@&lt;gpmaster&gt;
gpadmin@gpmaster$ . /usr/local/synxdb-db/synxdb_path.sh
</code></pre>
</li>
<li>
<p>Obtain a copy of the test bench from the <code>gpbackup</code> github repository. For example:</p>
<pre><code>$ git clone git@github.com:synxdb-db/gpbackup.git
</code></pre>
<p>The clone operation creates a directory named <code>gpbackup/</code> in the current working directory.</p>
</li>
<li>
<p>Locate the test bench program in the <code>gpbackup/master/plugins</code> directory. For example:</p>
<pre><code>$ ls gpbackup/master/plugins/plugin_test_bench.sh
</code></pre>
</li>
<li>
<p>Copy the plugin executable program and the plugin configuration YAML file from your development system to the SynxDB master host. Note the file system location to which you copied the files.</p>
</li>
<li>
<p>Copy the plugin executable program from the SynxDB master host to the same file system location on each segment host.</p>
</li>
<li>
<p>If required, edit the plugin configuration YAML file to specify the absolute path of the plugin executable program that you just copied to the SynxDB segments.</p>
</li>
<li>
<p>Run the test bench program against the plugin. For example:</p>
<pre><code>$ gpbackup/master/plugins/plugin_test_bench.sh /path/to/pluginexec /path/to/plugincfg.yaml
</code></pre>
</li>
<li>
<p>Examine the test bench output. Your plugin passed the test bench if all output messages specify <code>RUNNING</code> and <code>PASSED</code>. For example:</p>
<pre><code># ----------------------------------------------
# Starting gpbackup plugin tests
# ----------------------------------------------
[RUNNING] plugin_api_version
[PASSED] plugin_api_version
[RUNNING] setup_plugin_for_backup
[RUNNING] backup_file
[RUNNING] setup_plugin_for_restore
[RUNNING] restore_file
[PASSED] setup_plugin_for_backup
[PASSED] backup_file
[PASSED] setup_plugin_for_restore
[PASSED] restore_file
[RUNNING] backup_data
[RUNNING] restore_data
[PASSED] backup_data
[PASSED] restore_data
[RUNNING] cleanup_plugin_for_backup
[PASSED] cleanup_plugin_for_backup
[RUNNING] cleanup_plugin_for_restore
[PASSED] cleanup_plugin_for_restore
[RUNNING] gpbackup with test database
[RUNNING] gprestore with test database
[PASSED] gpbackup and gprestore
# ----------------------------------------------
# Finished gpbackup plugin tests
# ----------------------------------------------
</code></pre>
</li>
</ol>
<h2 id="packaging-and-deploying-a-backuprestore-storage-plugin"><a class="header" href="#packaging-and-deploying-a-backuprestore-storage-plugin"><a id="topic9339b"></a>Packaging and Deploying a Backup/Restore Storage Plugin</a></h2>
<p>Your backup/restore storage plugin is ready to be deployed to a SynxDB installation after the plugin passes your testing and the test bench verification. When you package the backup/restore storage plugin, consider the following:</p>
<ul>
<li>The backup/restore storage plugin must be installed in the same file system location on every host in the SynxDB cluster. Provide installation instructions for the plugin identifying the same.</li>
<li>The <code>gpadmin</code> user must have permission to traverse the file system path to the backup/restore plugin executable program.</li>
<li>Include a template configuration file with the plugin.</li>
<li>Document the valid plugin configuration keywords, making sure to include the syntax of expected values.</li>
<li>Document required <code>gpbackup</code> options and how they affect plugin processing.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../admin_guide/managing/backup-s3-plugin.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../admin_guide/managing/plugin_api/backup_data.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../admin_guide/managing/backup-s3-plugin.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../admin_guide/managing/plugin_api/backup_data.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
