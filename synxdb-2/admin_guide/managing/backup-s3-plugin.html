<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Using the S3 Storage Plugin with gpbackup and gprestore - SynxDB 2 Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SynxDB 2 Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <a href="https://www.synxdata.com/"><img id="fa fa-print" src="../../SYNX-Text-and-Circular-Logo-142x28-White-text-Black-background.png" alt="Synx Data Labs Logo"/></a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="using-the-s3-storage-plugin-with-gpbackup-and-gprestore"><a class="header" href="#using-the-s3-storage-plugin-with-gpbackup-and-gprestore">Using the S3 Storage Plugin with gpbackup and gprestore</a></h1>
<p>The S3 storage plugin application lets you use an Amazon Simple Storage Service (Amazon S3) location to store and retrieve backups when you run <a href="../../utility_guide/ref/gpbackup.html">gpbackup</a> and <a href="../../utility_guide/ref/gprestore.html">gprestore</a>. Amazon S3 provides secure, durable, highly-scalable object storage. The S3 plugin streams the backup data from a named pipe (FIFO) directly to the S3 bucket without generating local disk I/O.</p>
<p>The S3 storage plugin can also connect to an Amazon S3 compatible service such as <a href="https://www.emc.com/en-us/storage/ecs/index.htm">Dell EMC Elastic Cloud Storage</a> (ECS), <a href="https://www.minio.io/">Minio</a>, and <a href="https://cloudian.com/products/hyperstore/">Cloudian HyperStore</a>.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites"><a id="prereq"></a>Prerequisites</a></h2>
<p>Using Amazon S3 to back up and restore data requires an Amazon AWS account with access to the Amazon S3 bucket. These are the Amazon S3 bucket permissions required for backing up and restoring data:</p>
<ul>
<li>Upload/Delete for the S3 user ID that uploads the files</li>
<li>Open/Download and View for the S3 user ID that accesses the files</li>
</ul>
<p>For information about Amazon S3, see <a href="https://aws.amazon.com/s3/">Amazon S3</a>. For information about Amazon S3 regions and endpoints, see <a href="http://docs.aws.amazon.com/general/latest/gr/rande.html">AWS service endpoints</a>. For information about S3 buckets and folders, see the <a href="https://aws.amazon.com/documentation/s3/">Amazon S3 documentation</a>.</p>
<h2 id="installing-the-s3-storage-plugin"><a class="header" href="#installing-the-s3-storage-plugin"><a id="insts3"></a>Installing the S3 Storage Plugin</a></h2>
<p>The S3 storage plugin is included with the SynxDB Backup and Restore release. Use the latest S3 plugin release with the latest Backup and Restore, to avoid any incompatibilities.</p>
<p>The S3 storage plugin application must be in the same location on every SynxDB host, for example <code>$GPHOME/bin/gpbackup_s3_plugin</code>. The S3 storage plugin requires a configuration file, installed only on the master host.</p>
<h2 id="using-the-s3-storage-plugin"><a class="header" href="#using-the-s3-storage-plugin"><a id="uses3"></a>Using the S3 Storage Plugin</a></h2>
<p>To use the S3 storage plugin application, specify the location of the plugin, the S3 login credentials, and the backup location in a configuration file. For information about the configuration file, see <a href="#s3-plugin-config">S3 Storage Plugin Configuration File Format</a>.</p>
<p>When running <code>gpbackup</code> or <code>gprestore</code>, specify the configuration file with the option <code>--plugin-config</code>.</p>
<pre><code>gpbackup --dbname &lt;database-name&gt; --plugin-config /&lt;path-to-config-file&gt;/&lt;s3-config-file&gt;.yaml
</code></pre>
<p>When you perform a backup operation using <code>gpbackup</code> with the <code>--plugin-config</code> option, you must also specify the <code>--plugin-config</code> option when restoring with <code>gprestore</code>.</p>
<pre><code>gprestore --timestamp &lt;YYYYMMDDHHMMSS&gt; --plugin-config /&lt;path-to-config-file&gt;/&lt;s3-config-file&gt;.yaml
</code></pre>
<p>The S3 plugin stores the backup files in the S3 bucket, in a location similar to:</p>
<pre><code>&lt;folder&gt;/backups/&lt;datestamp&gt;/&lt;timestamp&gt;
</code></pre>
<p>Where folder is the location you specified in the S3 configuration file, and datestamp and timestamp are the backup date and time stamps.</p>
<p>The S3 storage plugin logs are in <code>&lt;gpadmin_home&gt;/gpAdmin/gpbackup_s3_plugin_timestamp.log</code> on each SynxDB host system. The timestamp format is <code>YYYYMMDDHHMMSS</code>.</p>
<p><strong>Example</strong></p>
<p>This is an example S3 storage plugin configuration file, named <code>s3-test-config.yaml</code>, that is used in the next <code>gpbackup</code> example command.</p>
<pre><code>executablepath: $GPHOME/bin/gpbackup_s3_plugin
options: 
  region: us-west-2
  aws_access_key_id: test-s3-user
  aws_secret_access_key: asdf1234asdf
  bucket: gpdb-backup
  folder: test/backup3
</code></pre>
<p>This <code>gpbackup</code> example backs up the database demo using the S3 storage plugin with absolute path <code>/home/gpadmin/s3-test</code>.</p>
<pre><code>gpbackup --dbname demo --plugin-config /home/gpadmin/s3-test/s3-test-config.yaml
</code></pre>
<p>The S3 storage plugin writes the backup files to this S3 location in the AWS region us-west-2.</p>
<pre><code>gpdb-backup/test/backup3/backups/&lt;YYYYMMDD&gt;/&lt;YYYYMMDDHHMMSS&gt;/
</code></pre>
<p>This example restores a specific backup set defined by the <code>20201206233124</code> timestamp, using the S3 plugin configuration file.</p>
<pre><code>gprestore --timestamp 20201206233124 --plugin-config /home/gpadmin/s3-test/s3-test-config.yaml
</code></pre>
<h2 id="s3-storage-plugin-configuration-file-format"><a class="header" href="#s3-storage-plugin-configuration-file-format"><a id="s3-plugin-config"></a>S3 Storage Plugin Configuration File Format</a></h2>
<p>The configuration file specifies the absolute path to the SynxDB S3 storage plugin executable, connection credentials, and S3 location.</p>
<p>The S3 storage plugin configuration file uses the <a href="http://yaml.org/spec/1.1/">YAML 1.1</a> document format and implements its own schema for specifying the location of the SynxDB S3 storage plugin, connection credentials, and S3 location and login information.</p>
<p>The configuration file must be a valid YAML document. The <code>gpbackup</code> and <code>gprestore</code> utilities process the control file document in order and use indentation (spaces) to determine the document hierarchy and the relationships of the sections to one another. The use of white space is significant. White space should not be used simply for formatting purposes, and tabs should not be used at all.</p>
<p>This is the structure of a S3 storage plugin configuration file.</p>
<pre><code>executablepath: &lt;absolute-path-to-gpbackup_s3_plugin&gt;
options: 
  region: &lt;aws-region&gt;
  endpoint: &lt;S3-endpoint&gt;
  aws_access_key_id: &lt;aws-user-id&gt;
  aws_secret_access_key: &lt;aws-user-id-key&gt;
  bucket: &lt;s3-bucket&gt;
  folder: &lt;s3-location&gt;
  encryption: [on|off]
  backup_max_concurrent_requests: [int]
    # default value is 6
  backup_multipart_chunksize: [string] 
    # default value is 500MB
  restore_max_concurrent_requests: [int]
    # default value is 6
  restore_multipart_chunksize: [string] 
    # default value is 500MB
  http_proxy:
        http://&lt;your_username&gt;:&lt;your_secure_password&gt;@proxy.example.com:proxy_port
</code></pre>
<p><strong>Note:</strong> The S3 storage plugin does not support filtered restore operations and the associated <code>restore_subset</code> plugin configuration property.</p>
<p><code>executablepath</code>
:   Required. Absolute path to the plugin executable. For example, the SynxDB installation location is <code>$GPHOME/bin/gpbackup_s3_plugin</code>. The plugin must be in the same location on every SynxDB host.</p>
<p><code>options</code>
:   Required. Begins the S3 storage plugin options section.</p>
<p><code>region</code>
:   Required for AWS S3. If connecting to an S3 compatible service, this option is not required, <strong>with one exception</strong>: If you are using Minio object storage and have specified a value for the <code>Region</code> setting on the Minio server side you must set this <code>region</code> option to the same value.</p>
<p><code>endpoint</code>
:   Required for an S3 compatible service. Specify this option to connect to an S3 compatible service such as ECS. The plugin connects to the specified S3 endpoint (hostname or IP address) to access the S3 compatible data store.</p>
<p>If this option is specified, the plugin ignores the <code>region</code> option and does not use AWS to resolve the endpoint. When this option is not specified, the plugin uses the <code>region</code> to determine AWS S3 endpoint.</p>
<p><code>aws_access_key_id</code>
:   Optional. The S3 ID to access the S3 bucket location that stores backup files.</p>
<p>If this parameter is not specified, S3 authentication uses information from the session environment. See <code>aws_secret_access_key</code>.</p>
<p><code>aws_secret_access_key</code>
:   Required only if you specify <code>aws_access_key_id</code>. The S3 passcode for the S3 ID to access the S3 bucket location.</p>
<p>If <code>aws_access_key_id</code> and <code>aws_secret_access_key</code> are not specified in the configuration file, the S3 plugin uses S3 authentication information from the system environment of the session running the backup operation. The S3 plugin searches for the information in these sources, using the first available source.</p>
<ol>
<li>The environment variables <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code>.</li>
<li>The authentication information set with the AWS CLI command <code>aws configure</code>.</li>
<li>The credentials of the Amazon EC2 IAM role if the backup is run from an EC2 instance.</li>
</ol>
<p><code>bucket</code>
:   Required. The name of the S3 bucket in the AWS region or S3 compatible data store. The bucket must exist.</p>
<p><code>folder</code>
:   Required. The S3 location for backups. During a backup operation, the plugin creates the S3 location if it does not exist in the S3 bucket.</p>
<p><code>encryption</code>
:   Optional. Enable or disable use of Secure Sockets Layer (SSL) when connecting to an S3 location. Default value is <code>on</code>, use connections that are secured with SSL. Set this option to <code>off</code> to connect to an S3 compatible service that is not configured to use SSL.</p>
<p>Any value other than <code>on</code> or <code>off</code> is not accepted.</p>
<p><code>backup_max_concurrent_requests</code>
:   Optional. The segment concurrency level for a file artifact within a single backup/upload request. The default value is set to 6. Use this parameter in conjuction with the <code>gpbackup --jobs</code> flag, to increase your overall backup concurrency.</p>
<p>Example: In a 4 node cluster, with 12 segments (3 per node), if the <code>--jobs</code> flag is set to 10, there could be 120 concurrent backup requests. With the <code>backup_max_concurrent_requests</code> parameter set to 6, the total S3 concurrent upload threads during a single backup session would reach 720 (120 x 6).</p>
<p><strong>Note:</strong> If the upload artifact is 10MB (see <code>backup_multipart_chunksize</code>), the <code>backup_max_concurrent_requests</code> parameter would not take effect since the file is smaller than the chunk size.</p>
<p><code>backup_multipart_chunksize</code>
:   Optional. The file chunk size of the S3 multipart upload request in Megabytes (for example 20MB), Gigabytes (for example 1GB), or bytes (for example 1048576B). The default value is 500MB and the minimum value is 5MB (or 5242880B). Use this parameter along with the <code>--jobs</code>flag and the <code>backup_max_concurrent_requests</code> parameter to fine tune your backups. Set the chunksize based on your individual segment file size. S3 supports up to 10,000 max total partitions for a single file upload.</p>
<p><code>restore_max_concurrent_requests</code>
:   Optional. The level of concurrency for downloading a file artifact within a single restore request. The default value is set to 6.</p>
<p><code>restore_multipart_chunksize</code>
:   Optional. The file chunk size of the S3 multipart download request in Megabytes (for example 20MB), Gigabytes (for example 1GB), or bytes (for example 1048576B). The default value is 500MB. Use this parameter along with the <code>restore_max_concurrent_requests</code> parameter to fine tune your restores.</p>
<p><code>http_proxy</code>
:   Optional. Allow AWS S3 access via a proxy server. The parameter should contain the proxy url in the form of <code>http://username:password@proxy.example.com:proxy_port</code> or <code>http://proxy.example.com:proxy_port</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../admin_guide/managing/backup-plugins.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../admin_guide/managing/backup-plugin-api.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../admin_guide/managing/backup-plugins.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../admin_guide/managing/backup-plugin-api.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
