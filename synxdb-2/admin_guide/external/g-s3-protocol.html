<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>s3:// Protocol - SynxDB 2 Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SynxDB 2 Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <a href="https://www.synxdata.com/"><img id="fa fa-print" src="../../SYNX-Text-and-Circular-Logo-142x28-White-text-Black-background.png" alt="Synx Data Labs Logo"/></a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="s3-protocol"><a class="header" href="#s3-protocol">s3:// Protocol</a></h1>
<p>The <code>s3</code> protocol is used in a URL that specifies the location of an Amazon S3 bucket and a prefix to use for reading or writing files in the bucket.</p>
<p>Amazon Simple Storage Service (Amazon S3) provides secure, durable, highly-scalable object storage. For information about Amazon S3, see <a href="https://aws.amazon.com/s3/">Amazon S3</a>.</p>
<p>You can define read-only external tables that use existing data files in the S3 bucket for table data, or writable external tables that store the data from INSERT operations to files in the S3 bucket. SynxDB uses the S3 URL and prefix specified in the protocol URL either to select one or more files for a read-only table, or to define the location and filename format to use when uploading S3 files for <code>INSERT</code> operations to writable tables.</p>
<p>The <code>s3</code> protocol also supports <a href="https://www.dell.com/en-us/lp/learn/data-storage/ecs.htm">Dell Elastic Cloud Storage</a> (ECS), an Amazon S3 compatible service.</p>
<blockquote>
<p><strong>Note</strong> The <code>pxf</code> protocol can access data in S3 and other object store systems such as Azure, Google Cloud Storage, and Minio. The <code>pxf</code> protocol can also access data in external Hadoop systems (HDFS, Hive, HBase), and SQL databases. See <a href="g-pxf-protocol.html">pxf:// Protocol</a>.</p>
</blockquote>
<p>This topic contains the sections:</p>
<ul>
<li><a href="#s3_prereq">Configuring the s3 Protocol</a></li>
<li><a href="#s3_using">Using s3 External Tables</a></li>
<li><a href="#section_stk_c2r_kx">About the s3 Protocol LOCATION URL</a></li>
<li><a href="#section_c2f_zvs_3x">About Reading and Writing S3 Data Files</a></li>
<li><a href="#s3_serversideencrypt">s3 Protocol AWS Server-Side Encryption Support</a></li>
<li><a href="#s3_proxy">s3 Protocol Proxy Support</a></li>
<li><a href="#s3_auth">About Providing the S3 Authentication Credentials</a></li>
<li><a href="#s3_config_file">About the s3 Protocol Configuration File</a></li>
<li><a href="#s3_config_param">About Specifying the Configuration File Location</a></li>
<li><a href="#section_tsq_n3t_3x">s3 Protocol Limitations</a></li>
<li><a href="#s3chkcfg_utility">Using the gpcheckcloud Utility</a></li>
</ul>
<h2 id="configuring-the-s3-protocol"><a class="header" href="#configuring-the-s3-protocol"><a id="s3_prereq"></a>Configuring the s3 Protocol</a></h2>
<p>You must configure the <code>s3</code> protocol before you can use it. Perform these steps in each database in which you want to use the protocol:</p>
<ol>
<li>
<p>Create the read and write functions for the <code>s3</code> protocol library:</p>
<pre><code>CREATE OR REPLACE FUNCTION write_to_s3() RETURNS integer AS
   '$libdir/gps3ext.so', 's3_export' LANGUAGE C STABLE;
</code></pre>
<pre><code>CREATE OR REPLACE FUNCTION read_from_s3() RETURNS integer AS
   '$libdir/gps3ext.so', 's3_import' LANGUAGE C STABLE;
</code></pre>
</li>
<li>
<p>Declare the <code>s3</code> protocol and specify the read and write functions you created in the previous step:</p>
<p>To allow only SynxDB superusers to use the protocol, create it as follows:</p>
<pre><code>CREATE PROTOCOL s3 (writefunc = write_to_s3, readfunc = read_from_s3);
</code></pre>
<p>If you want to permit non-superusers to use the <code>s3</code> protocol, create it as a <code>TRUSTED</code> protocol and <code>GRANT</code> access to those users. For example:</p>
<pre><code>CREATE TRUSTED PROTOCOL s3 (writefunc = write_to_s3, readfunc = read_from_s3);
GRANT ALL ON PROTOCOL s3 TO user1, user2;
</code></pre>
<blockquote>
<p><strong>Note</strong> The protocol name <code>s3</code> must be the same as the protocol of the URL specified for the external table that you create to access an S3 resource.</p>
</blockquote>
<p>The corresponding function is called by every SynxDB segment instance.</p>
</li>
</ol>
<h2 id="using-s3-external-tables"><a class="header" href="#using-s3-external-tables"><a id="s3_using"></a>Using s3 External Tables</a></h2>
<p>Follow these basic steps to use the <code>s3</code> protocol with SynxDB external tables. Each step includes links to relevant topics from which you can obtain more information. See also <a href="#section_tsq_n3t_3x">s3 Protocol Limitations</a> to better understand the capabilities and limitations of s3 external tables:</p>
<ol>
<li>
<p><a href="#s3_prereq">Configure the s3 Protocol</a>.</p>
</li>
<li>
<p>Create the <code>s3</code> protocol configuration file:</p>
<ol>
<li>
<p>Create a template <code>s3</code> protocol configuration file using the <code>gpcheckcloud</code> utility:</p>
<pre><code>gpcheckcloud -t &gt; ./mytest_s3.config
</code></pre>
</li>
<li>
<p>(Optional) Edit the template file to specify the <code>accessid</code> and <code>secret</code> authentication credentials required to connect to the S3 location. See <a href="#s3_auth">About Providing the S3 Authentication Credentials</a> and <a href="#s3_config_file">About the s3 Protocol Configuration File</a> for information about specifying these and other <code>s3</code> protocol configuration parameters.</p>
</li>
</ol>
</li>
<li>
<p>SynxDB can access an <code>s3</code> protocol configuration file when the file is located on each segment host or when the file is served up by an <code>http/https</code> server. Identify where you plan to locate the configuration file, and note the location and configuration option (if applicable). Refer to <a href="#s3_config_param">About Specifying the Configuration File Location</a> for more information about the location options for the file.</p>
<p>If you are relying on the AWS credential file to authenticate, this file must reside at <code>~/.aws/credentials</code> on each SynxDB segment host.</p>
</li>
<li>
<p>Use the <code>gpcheckcloud</code> utility to validate connectivity to the S3 bucket. You must specify the S3 endpoint name and bucket that you want to check.</p>
<p>For example, if the <code>s3</code> protocol configuration file resides in the default location, you would run the following command:</p>
<pre><code>gpcheckcloud -c "s3://&lt;s3-endpoint&gt;/&lt;s3-bucket&gt;"
</code></pre>
<p><code>gpcheckcloud</code> attempts to connect to the S3 endpoint and lists any files in the S3 bucket, if available. A successful connection ends with the message:</p>
<pre><code>Your configuration works well.
</code></pre>
<p>You can optionally use <code>gpcheckcloud</code> to validate uploading to and downloading from the S3 bucket. Refer to <a href="#s3chkcfg_utility">Using the gpcheckcloud Utility</a> for information about this utility and other usage examples.</p>
</li>
<li>
<p>Create an s3 external table by specifying an <code>s3</code> protocol URL in the <code>CREATE EXTERNAL TABLE</code> command, <code>LOCATION</code> clause.</p>
<p>For read-only s3 tables, the URL defines the location and prefix used to select existing data files that comprise the s3 table. For example:</p>
<pre><code>CREATE READABLE EXTERNAL TABLE S3TBL (date text, time text, amt int)
   LOCATION('s3://s3-us-west-2.amazonaws.com/s3test.example.com/dataset1/normal/ config=/home/gpadmin/aws_s3/s3.conf')
   FORMAT 'csv';
</code></pre>
<p>For writable s3 tables, the protocol URL defines the S3 location in which SynxDB writes the data files that back the table for <code>INSERT</code> operations. You can also specify a prefix that SynxDB will add to the files that it creates. For example:</p>
<pre><code>CREATE WRITABLE EXTERNAL TABLE S3WRIT (LIKE S3TBL)
   LOCATION('s3://s3-us-west-2.amazonaws.com/s3test.example.com/dataset1/normal/ config=/home/gpadmin/aws_s3/s3.conf')
   FORMAT 'csv';
</code></pre>
<p>Refer to <a href="#section_stk_c2r_kx">About the s3 Protocol LOCATION URL</a> for more information about the <code>s3</code> protocol URL.</p>
</li>
</ol>
<h2 id="about-the-s3-protocol-location-url"><a class="header" href="#about-the-s3-protocol-location-url"><a id="section_stk_c2r_kx"></a>About the s3 Protocol LOCATION URL</a></h2>
<p>When you use the <code>s3</code> protocol, you specify an S3 file location and optional configuration file location and region parameters in the <code>LOCATION</code> clause of the <code>CREATE EXTERNAL TABLE</code> command. The syntax follows:</p>
<pre><code>'s3://&lt;S3_endpoint&gt;[:&lt;port&gt;]/&lt;bucket_name&gt;/[&lt;S3_prefix&gt;] [region=&lt;S3_region&gt;] [config=&lt;config_file_location&gt; | config_server=&lt;url&gt;] [section=&lt;section_name&gt;]'
</code></pre>
<p>The <code>s3</code> protocol requires that you specify the S3 endpoint and S3 bucket name. Each SynxDB segment host must have access to the S3 location. The optional S3_prefix value is used to select files for read-only S3 tables, or as a filename prefix to use when uploading files for s3 writable tables.</p>
<blockquote>
<p><strong>Note</strong> The SynxDB <code>s3</code> protocol URL must include the S3 endpoint hostname.</p>
</blockquote>
<p>To specify an ECS endpoint (an Amazon S3 compatible service) in the <code>LOCATION</code> clause, you must set the <code>s3</code> protocol configuration file parameter <code>version</code> to <code>2</code>. The <code>version</code> parameter controls whether the <code>region</code> parameter is used in the <code>LOCATION</code> clause. You can also specify an Amazon S3 location when the <code>version</code> parameter is 2. For information about the <code>version</code> parameter, see <a href="#s3_config_file">About the s3 Protocol Configuration File</a>.</p>
<blockquote>
<p><strong>Note</strong> Although the S3_prefix is an optional part of the syntax, you should always include an S3 prefix for both writable and read-only s3 tables to separate datasets as part of the <a href="../../ref_guide/sql_commands/CREATE_EXTERNAL_TABLE.html">CREATE EXTERNAL TABLE</a> syntax.</p>
</blockquote>
<p>For writable s3 tables, the <code>s3</code> protocol URL specifies the endpoint and bucket name where SynxDB uploads data files for the table. The S3 file prefix is used for each new file uploaded to the S3 location as a result of inserting data to the table. See <a href="#section_c2f_zvs_3x">About Reading and Writing S3 Data Files</a>.</p>
<p>For read-only s3 tables, the S3 file prefix is optional. If you specify an S3_prefix, then the <code>s3</code> protocol selects all files that start with the specified prefix as data files for the external table. The <code>s3</code> protocol does not use the slash character (<code>/</code>) as a delimiter, so a slash character following a prefix is treated as part of the prefix itself.</p>
<p>For example, consider the following 5 files that each have the S3_endpoint named <code>s3-us-west-2.amazonaws.com</code> and the bucket_name <code>test1</code>:</p>
<pre><code>s3://s3-us-west-2.amazonaws.com/test1/abc
s3://s3-us-west-2.amazonaws.com/test1/abc/
s3://s3-us-west-2.amazonaws.com/test1/abc/xx
s3://s3-us-west-2.amazonaws.com/test1/abcdef
s3://s3-us-west-2.amazonaws.com/test1/abcdefff
</code></pre>
<ul>
<li>If the S3 URL is provided as <code>s3://s3-us-west-2.amazonaws.com/test1/abc</code>, then the <code>abc</code> prefix selects all 5 files.</li>
<li>If the S3 URL is provided as <code>s3://s3-us-west-2.amazonaws.com/test1/abc/</code>, then the <code>abc/</code> prefix selects the files <code>s3://s3-us-west-2.amazonaws.com/test1/abc/</code> and <code>s3://s3-us-west-2.amazonaws.com/test1/abc/xx</code>.</li>
<li>If the S3 URL is provided as <code>s3://s3-us-west-2.amazonaws.com/test1/abcd</code>, then the <code>abcd</code> prefix selects the files <code>s3://s3-us-west-2.amazonaws.com/test1/abcdef</code> and <code>s3://s3-us-west-2.amazonaws.com/test1/abcdefff</code></li>
</ul>
<p>Wildcard characters are not supported in an S3_prefix; however, the S3 prefix functions as if a wildcard character immediately followed the prefix itself.</p>
<p>All of the files selected by the S3 URL (S3_endpoint/bucket_name/S3_prefix) are used as the source for the external table, so they must have the same format. Each file must also contain complete data rows. A data row cannot be split between files.</p>
<p>For information about the Amazon S3 endpoints see <a href="http://docs.aws.amazon.com/general/latest/gr/rande.html">http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region</a>. For information about S3 buckets and folders, see the Amazon S3 documentation <a href="https://aws.amazon.com/documentation/s3/">https://aws.amazon.com/documentation/s3/</a>. For information about the S3 file prefix, see the Amazon S3 documentation <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/ListingKeysHierarchy.html">Listing Keys Hierarchically Using a Prefix and Delimiter</a>.</p>
<p>You use the <code>config</code> or <code>config_server</code> parameter to specify the location of the required <code>s3</code> protocol configuration file that contains AWS connection credentials and communication parameters as described in <a href="#s3_config_param">About Specifying the Configuration File Location</a>.</p>
<p>Use the <code>section</code> parameter to specify the name of the configuration file section from which the <code>s3</code> protocol reads configuration parameters. The default <code>section</code> is named <code>default</code>. When you specify the section name in the configuration file, enclose it in brackets (for example, <code>[default]</code>).</p>
<h2 id="about-reading-and-writing-s3-data-files"><a class="header" href="#about-reading-and-writing-s3-data-files"><a id="section_c2f_zvs_3x"></a>About Reading and Writing S3 Data Files</a></h2>
<p>You can use the <code>s3</code> protocol to read and write data files on Amazon S3.</p>
<p><strong>Reading S3 Files</strong></p>
<p>The S3 permissions on any file that you read must include <code>Open/Download</code> and <code>View</code> for the S3 user ID that accesses the files.</p>
<p>For read-only s3 tables, all of the files specified by the S3 file location (S3_endpoint/bucket_name/S3_prefix) are used as the source for the external table and must have the same format. Each file must also contain complete data rows. If the files contain an optional header row, the column names in the header row cannot contain a newline character (<code>\n</code>) or a carriage return (<code>\r</code>). Also, the column delimiter cannot be a newline character (<code>\n</code>) or a carriage return character (<code>\r</code>).</p>
<p>The <code>s3</code> protocol recognizes gzip and deflate compressed files and automatically decompresses the files. For gzip compression, the protocol recognizes the format of a gzip compressed file. For deflate compression, the protocol assumes a file with the <code>.deflate</code> suffix is a deflate compressed file.</p>
<p>Each SynxDB segment can download one file at a time from the S3 location using several threads. To take advantage of the parallel processing performed by the SynxDB segments, the files in the S3 location should be similar in size and the number of files should allow for multiple segments to download the data from the S3 location. For example, if the SynxDB system consists of 16 segments and there was sufficient network bandwidth, creating 16 files in the S3 location allows each segment to download a file from the S3 location. In contrast, if the location contained only 1 or 2 files, only 1 or 2 segments download data.</p>
<p><strong>Writing S3 Files</strong></p>
<p>Writing a file to S3 requires that the S3 user ID have <code>Upload/Delete</code> permissions.</p>
<p>When you initiate an <code>INSERT</code> operation on a writable s3 table, each SynxDB segment uploads a single file to the configured S3 bucket using the filename format <code>&lt;prefix&gt;&lt;segment_id&gt;&lt;random&gt;.&lt;extension&gt;[.gz]</code> where:</p>
<ul>
<li><code>&lt;prefix&gt;</code> is the prefix specified in the S3 URL.</li>
<li><code>&lt;segment_id&gt;</code> is the SynxDB segment ID.</li>
<li><code>&lt;random&gt;</code> is a random number that is used to ensure that the filename is unique.</li>
<li><code>&lt;extension&gt;</code> describes the file type (<code>.txt</code> or .csv, depending on the value you provide in the <code>FORMAT</code> clause of <code>CREATE WRITABLE EXTERNAL TABLE</code>). Files created by the <code>gpcheckcloud</code> utility always uses the extension .data.</li>
<li>.gz is appended to the filename if compression is enabled for s3 writable tables (the default).</li>
</ul>
<p>You can configure the buffer size and the number of threads that segments use for uploading files. See <a href="#s3_config_file">About the s3 Protocol Configuration File</a>.</p>
<h2 id="s3-protocol-aws-server-side-encryption-support"><a class="header" href="#s3-protocol-aws-server-side-encryption-support"><a id="s3_serversideencrypt"></a>s3 Protocol AWS Server-Side Encryption Support</a></h2>
<p>SynxDB supports server-side encryption using Amazon S3-managed keys (SSE-S3) for AWS S3 files you access with readable and writable external tables created using the <code>s3</code> protocol. SSE-S3 encrypts your object data as it writes to disk, and transparently decrypts the data for you when you access it.</p>
<blockquote>
<p><strong>Note</strong> The <code>s3</code> protocol supports SSE-S3 only for Amazon Web Services S3 files. SS3-SE is not supported when accessing files in S3 compatible services.</p>
</blockquote>
<p>Your S3 account permissions govern your access to all S3 bucket objects, whether the data is encrypted or not. However, you must configure your client to use S3-managed keys for accessing encrypted data.</p>
<p>Refer to <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/serv-side-encryption.html">Protecting Data Using Server-Side Encryption</a> in the AWS documentation for additional information about AWS Server-Side Encryption.</p>
<p><strong>Configuring S3 Server-Side Encryption</strong></p>
<p><code>s3</code> protocol server-side encryption is deactivated by default. To take advantage of server-side encryption on AWS S3 objects you write using the SynxDB <code>s3</code> protocol, you must set the <code>server_side_encryption</code> configuration parameter in your <code>s3</code> protocol configuration file to the value <code>sse-s3</code>:</p>
<pre><code>
server_side_encryption = sse-s3

</code></pre>
<p>When the configuration file you provide to a <code>CREATE WRITABLE EXTERNAL TABLE</code> call using the <code>s3</code> protocol includes the <code>server_side_encryption = sse-s3</code> setting, SynxDB applies encryption headers for you on all <code>INSERT</code> operations on that external table. S3 then encrypts on write the object(s) identified by the URI you provided in the <code>LOCATION</code> clause.</p>
<p>S3 transparently decrypts data during read operations of encrypted files accessed via readable external tables you create using the <code>s3</code> protocol. No additional configuration is required.</p>
<p>For further encryption configuration granularity, you may consider creating Amazon Web Services S3 <em>Bucket Policy</em>(s), identifying the objects you want to encrypt and the write actions on those objects as described in the <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/UsingServerSideEncryption.html">Protecting Data Using Server-Side Encryption with Amazon S3-Managed Encryption Keys (SSE-S3)</a> AWS documentation.</p>
<h2 id="s3-protocol-proxy-support"><a class="header" href="#s3-protocol-proxy-support"><a id="s3_proxy"></a>s3 Protocol Proxy Support</a></h2>
<p>You can specify a URL that is the proxy that S3 uses to connect to a data source. S3 supports these protocols: HTTP and HTTPS. You can specify a proxy with the <code>s3</code> protocol configuration parameter <code>proxy</code> or an environment variable. If the configuration parameter is set, the environment variables are ignored.</p>
<p>To specify proxy with an environment variable, you set the environment variable based on the protocol: <code>http_proxy</code> or <code>https_proxy</code>. You can specify a different URL for each protocol by setting the appropriate environment variable. S3 supports these environment variables.</p>
<ul>
<li><code>all_proxy</code> specifies the proxy URL that is used if an environment variable for a specific protocol is not set.</li>
<li><code>no_proxy</code> specifies a comma-separated list of hosts names that do not use the proxy specified by an environment variable.</li>
</ul>
<p>The environment variables must be set must and must be accessible to SynxDB on all SynxDB hosts.</p>
<p>For information about the configuration parameter <code>proxy</code>, see <a href="#s3_config_file">About the s3 Protocol Configuration File</a>.</p>
<h2 id="about-providing-the-s3-authentication-credentials"><a class="header" href="#about-providing-the-s3-authentication-credentials"><a id="s3_auth"></a>About Providing the S3 Authentication Credentials</a></h2>
<p>The <code>s3</code> protocol obtains the S3 authentication credentials as follows:</p>
<ul>
<li>You specify the S3 <code>accessid</code> and <code>secret</code> parameters and their values in a named <code>section</code> of an <a href="#s3_config_file">s3 protocol configuration file</a>. The default section from which the <code>s3</code> protocol obtains this information is named <code>[default]</code>.</li>
<li>If you do not specify the <code>accessid</code> and <code>secret</code>, or these parameter values are empty, the <code>s3</code> protocol attempts to obtain the S3 authentication credentials from the <code>aws_access_key_id</code> and <code>aws_secret_access_key</code> parameters specified in a named <code>section</code> of the user’s AWS credential file. The default location of this file is <code>~/.aws/credentials</code>, and the default section is named <code>[default]</code>.</li>
</ul>
<h2 id="about-the-s3-protocol-configuration-file"><a class="header" href="#about-the-s3-protocol-configuration-file"><a id="s3_config_file"></a>About the s3 Protocol Configuration File</a></h2>
<p>An <code>s3</code> protocol configuration file contains Amazon Web Services (AWS) connection credentials and communication parameters.</p>
<p>The <code>s3</code> protocol configuration file is a text file that contains named sections and parameters. The default section is named <code>[default]</code>. An example configuration file follows:</p>
<pre><code>[default]
secret = "secret"
accessid = "user access id"
threadnum = 3
chunksize = 67108864
</code></pre>
<p>You can use the SynxDB <code>gpcheckcloud</code> utility to test the s3 protocol configuration file. See <a href="#s3chkcfg_utility">Using the gpcheckcloud Utility</a>.</p>
<p><strong>s3 Configuration File Parameters</strong></p>
<p><code>accessid</code>
:   Optional. AWS S3 ID to access the S3 bucket. Refer to <a href="#s3_auth">About Providing the S3 Authentication Credentials</a> for more information about specifying authentication credentials.</p>
<p><code>secret</code>
:   Optional. AWS S3 passcode for the S3 ID to access the S3 bucket. Refer to <a href="#s3_auth">About Providing the S3 Authentication Credentials</a> for more information about specifying authentication credentials.</p>
<p><code>autocompress</code>
:   For writable s3 external tables, this parameter specifies whether to compress files (using gzip) before uploading to S3. Files are compressed by default if you do not specify this parameter.</p>
<p><code>chunksize</code>
:   The buffer size that each segment thread uses for reading from or writing to the S3 server. The default is 64 MB. The minimum is 8MB and the maximum is 128MB.</p>
<p>When inserting data to a writable s3 table, each SynxDB segment writes the data into its buffer (using multiple threads up to the <code>threadnum</code> value) until it is full, after which it writes the buffer to a file in the S3 bucket. This process is then repeated as necessary on each segment until the insert operation completes.</p>
<p>Because Amazon S3 allows a maximum of 10,000 parts for multipart uploads, the minimum <code>chunksize</code> value of 8MB supports a maximum insert size of 80GB per SynxDB database segment. The maximum <code>chunksize</code> value of 128MB supports a maximum insert size 1.28TB per segment. For writable s3 tables, you must ensure that the <code>chunksize</code> setting can support the anticipated table size of your table. See <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/mpuoverview.html">Multipart Upload Overview</a> in the S3 documentation for more information about uploads to S3.</p>
<p><code>encryption</code>
:   Use connections that are secured with Secure Sockets Layer (SSL). Default value is <code>true</code>. The values <code>true</code>, <code>t</code>, <code>on</code>, <code>yes</code>, and <code>y</code> (case insensitive) are treated as <code>true</code>. Any other value is treated as <code>false</code>.</p>
<p>If the port is not specified in the URL in the <code>LOCATION</code> clause of the <code>CREATE EXTERNAL TABLE</code> command, the configuration file <code>encryption</code> parameter affects the port used by the <code>s3</code> protocol (port 80 for HTTP or port 443 for HTTPS). If the port is specified, that port is used regardless of the encryption setting.</p>
<p><code>gpcheckcloud_newline</code>
:   When downloading files from an S3 location, the <code>gpcheckcloud</code> utility appends a new line character to last line of a file if the last line of a file does not have an EOL (end of line) character. The default character is <code>\n</code> (newline). The value can be <code>\n</code>, <code>\r</code> (carriage return), or <code>\n\r</code> (newline/carriage return).</p>
<p>Adding an EOL character prevents the last line of one file from being concatenated with the first line of next file.</p>
<p><code>low_speed_limit</code>
:   The upload/download speed lower limit, in bytes per second. The default speed is 10240 (10K). If the upload or download speed is slower than the limit for longer than the time specified by <code>low_speed_time</code>, then the connection is stopped and retried. After 3 retries, the <code>s3</code> protocol returns an error. A value of 0 specifies no lower limit.</p>
<p><code>low_speed_time</code>
:   When the connection speed is less than <code>low_speed_limit</code>, this parameter specified the amount of time, in seconds, to wait before cancelling an upload to or a download from the S3 bucket. The default is 60 seconds. A value of 0 specifies no time limit.</p>
<p><code>proxy</code>
:   Specify a URL that is the proxy that S3 uses to connect to a data source. S3 supports these protocols: HTTP and HTTPS. This is the format for the parameter.</p>
<pre><code>proxy = &lt;protocol&gt;://[&lt;user&gt;:&lt;password&gt;@]&lt;proxyhost&gt;[:&lt;port&gt;]
</code></pre>
<p>If this parameter is not set or is an empty string (<code>proxy = ""</code>), S3 uses the proxy specified by the environment variable <code>http_proxy</code> or <code>https_proxy</code> (and the environment variables <code>all_proxy</code> and <code>no_proxy</code>). The environment variable that S3 uses depends on the protocol. For information about the environment variables, see <a href="g-s3-protocol.html#s3_proxy">s3 Protocol Proxy Support</a>.</p>
<p>There can be at most one <code>proxy</code> parameter in the configuration file. The URL specified by the parameter is the proxy for all supported protocols.</p>
<p><code>server_side_encryption</code>
:   The S3 server-side encryption method that has been configured for the bucket. SynxDB supports only server-side encryption with Amazon S3-managed keys, identified by the configuration parameter value <code>sse-s3</code>. Server-side encryption is deactivated (<code>none</code>) by default.</p>
<p><code>threadnum</code>
:   The maximum number of concurrent threads a segment can create when uploading data to or downloading data from the S3 bucket. The default is 4. The minimum is 1 and the maximum is 8.</p>
<p><code>verifycert</code>
:   Controls how the <code>s3</code> protocol handles authentication when establishing encrypted communication between a client and an S3 data source over HTTPS. The value is either <code>true</code> or <code>false</code>. The default value is <code>true</code>.</p>
<ul>
<li><code>verifycert=false</code> - Ignores authentication errors and allows encrypted communication over HTTPS.</li>
<li><code>verifycert=true</code> - Requires valid authentication (a proper certificate) for encrypted communication over HTTPS.</li>
</ul>
<p>Setting the value to <code>false</code> can be useful in testing and development environments to allow communication without changing certificates.</p>
<blockquote>
<p><strong>Caution</strong> Setting the value to <code>false</code> exposes a security risk by ignoring invalid credentials when establishing communication between a client and a S3 data store.</p>
</blockquote>
<p><code>version</code>
:   Specifies the version of the information specified in the <code>LOCATION</code> clause of the <code>CREATE EXTERNAL TABLE</code> command. The value is either <code>1</code> or <code>2</code>. The default value is <code>1</code>.</p>
<p>If the value is <code>1</code>, the <code>LOCATION</code> clause supports an Amazon S3 URL, and does not contain the <code>region</code> parameter. If the value is <code>2</code>, the <code>LOCATION</code> clause supports S3 compatible services and must include the <code>region</code> parameter. The <code>region</code> parameter specifies the S3 data source region. For this S3 URL <code>s3://s3-us-west-2.amazonaws.com/s3test.example.com/dataset1/normal/</code>, the AWS S3 region is <code>us-west-2</code>.</p>
<p>If <code>version</code> is 1 or is not specified, this is an example of the <code>LOCATION</code> clause of the <code>CREATE EXTERNAL TABLE</code> command that specifies an Amazon S3 endpoint.</p>
<pre><code>LOCATION ('s3://s3-us-west-2.amazonaws.com/s3test.example.com/dataset1/normal/ config=/home/gpadmin/aws_s3/s3.conf')
</code></pre>
<p>If <code>version</code> is 2, this is an example <code>LOCATION</code> clause with the <code>region</code> parameter for an AWS S3 compatible service.</p>
<pre><code>LOCATION ('s3://test.company.com/s3test.company/test1/normal/ region=local-test config=/home/gpadmin/aws_s3/s3.conf') 
</code></pre>
<p>If <code>version</code> is 2, the <code>LOCATION</code> clause can also specify an Amazon S3 endpoint. This example specifies an Amazon S3 endpoint that uses the <code>region</code> parameter.</p>
<pre><code>LOCATION ('s3://s3-us-west-2.amazonaws.com/s3test.example.com/dataset1/normal/ region=us-west-2 config=/home/gpadmin/aws_s3/s3.conf') 
</code></pre>
<blockquote>
<p><strong>Note</strong> SynxDB can require up to <code>threadnum * chunksize</code> memory on each segment host when uploading or downloading S3 files. Consider this <code>s3</code> protocol memory requirement when you configure overall SynxDB memory.</p>
</blockquote>
<h2 id="about-specifying-the-configuration-file-location"><a class="header" href="#about-specifying-the-configuration-file-location"><a id="s3_config_param"></a>About Specifying the Configuration File Location</a></h2>
<p>The default location of the <code>s3</code> protocol configuration file is a file named <code>s3.conf</code> that resides in the data directory of each SynxDB segment instance:</p>
<pre><code>&lt;gpseg_data_dir&gt;/&lt;gpseg_prefix&gt;&lt;N&gt;/s3/s3.conf
</code></pre>
<p>The gpseg_data_dir is the path to the SynxDB segment data directory, the gpseg_prefix is the segment prefix, and N is the segment ID. The segment data directory, prefix, and ID are set when you initialize a SynxDB system.</p>
<p>You may choose an alternate location for the <code>s3</code> protocol configuration file by specifying the optional <code>config</code> or <code>config_server</code> parameters in the <code>LOCATION</code> URL:</p>
<ul>
<li>
<p>You can simplify the configuration by using a single configuration file that resides in the same file system location on each segment host. In this scenario, you specify the <code>config</code> parameter in the <code>LOCATION</code> clause to identify the absolute path to the file. The following example specifies a location in the <code>gpadmin</code> home directory:</p>
<pre><code>LOCATION ('s3://s3-us-west-2.amazonaws.com/test/my_data config=/home/gpadmin/s3.conf')
</code></pre>
<p>The <code>/home/gpadmin/s3.conf</code> file must reside on each segment host, and all segment instances on a host use the file.</p>
</li>
<li>
<p>You also have the option to use an <code>http/https</code> server to serve up the configuration file. In this scenario, you specify an <code>http/https</code> server URL in the <code>config_server</code> parameter. You are responsible for configuring and starting the server, and each SynxDB segment host must be able to access the server. The following example specifies an IP address and port for an <code>https</code> server:</p>
<pre><code>LOCATION ('s3://s3-us-west-2.amazonaws.com/test/my_data config_server=https://203.0.113.0:8553')
</code></pre>
</li>
</ul>
<h2 id="s3-protocol-limitations"><a class="header" href="#s3-protocol-limitations"><a id="section_tsq_n3t_3x"></a>s3 Protocol Limitations</a></h2>
<p>These are <code>s3</code> protocol limitations:</p>
<ul>
<li>
<p>Only the S3 path-style URL is supported.</p>
<pre><code>s3://&lt;S3_endpoint&gt;/&lt;bucketname&gt;/[&lt;S3_prefix&gt;]
</code></pre>
</li>
<li>
<p>Only the S3 endpoint is supported. The protocol does not support virtual hosting of S3 buckets (binding a domain name to an S3 bucket).</p>
</li>
<li>
<p>AWS signature version 4 signing process is supported.</p>
<p>For information about the S3 endpoints supported by each signing process, see <a href="http://docs.aws.amazon.com/general/latest/gr/rande.html">http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region</a>.</p>
</li>
<li>
<p>Only a single URL and optional configuration file location and region parameters is supported in the <code>LOCATION</code> clause of the <code>CREATE EXTERNAL TABLE</code> command.</p>
</li>
<li>
<p>If the <code>NEWLINE</code> parameter is not specified in the <code>CREATE EXTERNAL TABLE</code> command, the newline character must be identical in all data files for specific prefix. If the newline character is different in some data files with the same prefix, read operations on the files might fail.</p>
</li>
<li>
<p>For writable s3 external tables, only the <code>INSERT</code> operation is supported. <code>UPDATE</code>, <code>DELETE</code>, and <code>TRUNCATE</code> operations are not supported.</p>
</li>
<li>
<p>Because Amazon S3 allows a maximum of 10,000 parts for multipart uploads, the maximum <code>chunksize</code> value of 128MB supports a maximum insert size of 1.28TB per SynxDB database segment for writable s3 tables. You must ensure that the <code>chunksize</code> setting can support the anticipated table size of your table. See <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/mpuoverview.html">Multipart Upload Overview</a> in the S3 documentation for more information about uploads to S3.</p>
</li>
<li>
<p>To take advantage of the parallel processing performed by the SynxDB segment instances, the files in the S3 location for read-only s3 tables should be similar in size and the number of files should allow for multiple segments to download the data from the S3 location. For example, if the SynxDB system consists of 16 segments and there was sufficient network bandwidth, creating 16 files in the S3 location allows each segment to download a file from the S3 location. In contrast, if the location contained only 1 or 2 files, only 1 or 2 segments download data.</p>
</li>
</ul>
<h2 id="using-the-gpcheckcloud-utility"><a class="header" href="#using-the-gpcheckcloud-utility"><a id="s3chkcfg_utility"></a>Using the gpcheckcloud Utility</a></h2>
<p>The SynxDB utility <code>gpcheckcloud</code> helps users create an <code>s3</code> protocol configuration file and test a configuration file. You can specify options to test the ability to access an S3 bucket with a configuration file, and optionally upload data to or download data from files in the bucket.</p>
<p>If you run the utility without any options, it sends a template configuration file to <code>STDOUT</code>. You can capture the output and create an <code>s3</code> configuration file to connect to Amazon S3.</p>
<p>The utility is installed in the SynxDB <code>$GPHOME/bin</code> directory.</p>
<p><strong>Syntax</strong></p>
<pre><code>gpcheckcloud {-c | -d} "s3://&lt;S3_endpoint&gt;/&lt;bucketname&gt;/[&lt;S3_prefix&gt;] [config=&lt;path_to_config_file&gt;]"

gpcheckcloud -u &lt;file_to_upload&gt; "s3://&lt;S3_endpoint&gt;/&lt;bucketname&gt;/[&lt;S3_prefix&gt;] [config=&lt;path_to_config_file&gt;]"
gpcheckcloud -t

gpcheckcloud -h
</code></pre>
<p><strong>Options</strong></p>
<p><code>-c</code>
:   Connect to the specified S3 location with the configuration specified in the <code>s3</code> protocol URL and return information about the files in the S3 location.</p>
<p>If the connection fails, the utility displays information about failures such as invalid credentials, prefix, or server address (DNS error), or server not available.</p>
<p><code>-d</code>
:   Download data from the specified S3 location with the configuration specified in the <code>s3</code> protocol URL and send the output to <code>STDOUT</code>.</p>
<p>If files are gzip compressed or have a <code>.deflate</code> suffix to indicate deflate compression, the uncompressed data is sent to <code>STDOUT</code>.</p>
<p><code>-u</code>
:   Upload a file to the S3 bucket specified in the <code>s3</code> protocol URL using the specified configuration file if available. Use this option to test compression and <code>chunksize</code> and <code>autocompress</code> settings for your configuration.</p>
<p><code>-t</code>
:   Sends a template configuration file to <code>STDOUT</code>. You can capture the output and create an <code>s3</code> configuration file to connect to Amazon S3.</p>
<p><code>-h</code>
:   Display <code>gpcheckcloud</code> help.</p>
<p><strong>Examples</strong></p>
<p>This example runs the utility without options to create a template <code>s3</code> configuration file <code>mytest_s3.config</code> in the current directory.</p>
<pre><code>gpcheckcloud -t &gt; ./mytest_s3.config
</code></pre>
<p>This example attempts to upload a local file, test-data.csv to an S3 bucket location using the <code>s3</code> configuration file <code>s3.mytestconf</code>:</p>
<pre><code>gpcheckcloud -u ./test-data.csv "s3://s3-us-west-2.amazonaws.com/test1/abc config=s3.mytestconf"
</code></pre>
<p>A successful upload results in one or more files placed in the S3 bucket using the filename format <code>abc&lt;segment_id&gt;&lt;random&gt;.data[.gz]</code>. See <a href="#section_c2f_zvs_3x">About Reading and Writing S3 Data Files</a>.</p>
<p>This example attempts to connect to an S3 bucket location with the <code>s3</code> protocol configuration file <code>s3.mytestconf</code>.</p>
<pre><code>gpcheckcloud -c "s3://s3-us-west-2.amazonaws.com/test1/abc config=s3.mytestconf"
</code></pre>
<p>This example attempts to connect to an S3 bucket location using the default location for the <code>s3</code> protocol configuration file (<code>s3/s3.conf</code> in segment data directories):</p>
<pre><code>gpcheckcloud -c "s3://s3-us-west-2.amazonaws.com/test1/abc"
</code></pre>
<p>Download all files from the S3 bucket location and send the output to <code>STDOUT</code>.</p>
<pre><code>gpcheckcloud -d "s3://s3-us-west-2.amazonaws.com/test1/abc config=s3.mytestconf"
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../admin_guide/external/g-pxf-protocol.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../admin_guide/external/g-accessing-ext-files-custom-protocol.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../admin_guide/external/g-pxf-protocol.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../admin_guide/external/g-accessing-ext-files-custom-protocol.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
