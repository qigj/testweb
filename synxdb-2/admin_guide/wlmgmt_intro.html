<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>SynxDB Memory Overview - SynxDB 2 Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SynxDB 2 Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <a href="https://www.synxdata.com/"><img id="fa fa-print" src="../SYNX-Text-and-Circular-Logo-142x28-White-text-Black-background.png" alt="Synx Data Labs Logo"/></a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="synxdb-memory-overview"><a class="header" href="#synxdb-memory-overview">SynxDB Memory Overview</a></h1>
<p>Memory is a key resource for a SynxDB system and, when used efficiently, can ensure high performance and throughput. This topic describes how segment host memory is allocated between segments and the options available to administrators to configure memory.</p>
<p>A SynxDB segment host runs multiple PostgreSQL instances, all sharing the host’s memory. The segments have an identical configuration and they consume similar amounts of memory, CPU, and disk IO simultaneously, while working on queries in parallel.</p>
<p>For best query throughput, the memory configuration should be managed carefully. There are memory configuration options at every level in SynxDB, from operating system parameters, to managing resources with resource queues and resource groups, to setting the amount of memory allocated to an individual query.</p>
<h2 id="segment-host-memory"><a class="header" href="#segment-host-memory"><a id="seghost"></a>Segment Host Memory</a></h2>
<p>On a SynxDB segment host, the available host memory is shared among all the processes running on the computer, including the operating system, SynxDB segment instances, and other application processes. Administrators must determine what SynxDB and non-SynxDB processes share the hosts’ memory and configure the system to use the memory efficiently. It is equally important to monitor memory usage regularly to detect any changes in the way host memory is consumed by SynxDB or other processes.</p>
<p>The following figure illustrates how memory is consumed on a SynxDB segment host when resource queue-based resource management is active.</p>
<p><img src="graphics/memory.png" alt="SynxDB Segment Host Memory" title="SynxDB Segment Host Memory" /></p>
<p>Beginning at the bottom of the illustration, the line labeled <em>A</em> represents the total host memory. The line directly above line <em>A</em> shows that the total host memory comprises both physical RAM and swap space.</p>
<p>The line labelled <em>B</em> shows that the total memory available must be shared by SynxDB and all other processes on the host. Non-SynxDB processes include the operating system and any other applications, for example system monitoring agents. Some applications may use a significant portion of memory and, as a result, you may have to adjust the number of segments per SynxDB host or the amount of memory per segment.</p>
<p>The segments (<em>C</em>) each get an equal share of the SynxDB Memory (<em>B</em>).</p>
<p>Within a segment, the currently active resource management scheme, <em>Resource Queues</em> or <em>Resource Groups</em>, governs how memory is allocated to run a SQL statement. These constructs allow you to translate business requirements into execution policies in your SynxDB system and to guard against queries that could degrade performance. For an overview of resource groups and resource queues, refer to <a href="wlmgmt.html">Managing Resources</a>.</p>
<h2 id="options-for-configuring-segment-host-memory"><a class="header" href="#options-for-configuring-segment-host-memory"><a id="opts"></a>Options for Configuring Segment Host Memory</a></h2>
<p>Host memory is the total memory shared by all applications on the segment host. You can configure the amount of host memory using any of the following methods:</p>
<ul>
<li>Add more RAM to the nodes to increase the physical memory.</li>
<li>Allocate swap space to increase the size of virtual memory.</li>
<li>Set the kernel parameters vm.overcommit_memory and vm.overcommit_ratio to configure how the operating system handles large memory allocation requests.</li>
</ul>
<p>The physical RAM and OS configuration are usually managed by the platform team and system administrators. See the <a href="../install_guide/prep_os.html#topic3">SynxDB Installation Guide</a> for the recommended kernel parameters and for how to set the <code>/etc/sysctl.conf</code> file parameters.</p>
<p>The amount of memory to reserve for the operating system and other processes is workload dependent. The minimum recommendation for operating system memory is 32GB, but if there is much concurrency in SynxDB, increasing to 64GB of reserved memory may be required. The largest user of operating system memory is SLAB, which increases as SynxDB concurrency and the number of sockets used increases.</p>
<p>The <code>vm.overcommit_memory</code> kernel parameter should always be set to 2, the only safe value for SynxDB.</p>
<p>The <code>vm.overcommit_ratio</code> kernel parameter sets the percentage of RAM that is used for application processes, the remainder reserved for the operating system. The default for Red Hat is 50 (50%). Setting this parameter too high may result in insufficient memory reserved for the operating system, which can cause segment host failure or database failure. Leaving the setting at the default of 50 is generally safe, but conservative. Setting the value too low reduces the amount of concurrency and the complexity of queries you can run at the same time by reducing the amount of memory available to SynxDB. When increasing <code>vm.overcommit_ratio</code>, it is important to remember to always reserve some memory for operating system activities.</p>
<p><strong>Configuring vm.overcommit_ratio when Resource Group-Based Resource Management is Active</strong></p>
<p>When resource group-based resource management is active, tune the operating system <code>vm.overcommit_ratio</code> as necessary. If your memory utilization is too low, increase the value; if your memory or swap usage is too high, decrease the setting.</p>
<p><strong>Configuring vm.overcommit_ratio when Resource Queue-Based Resource Management is Active</strong></p>
<p>To calculate a safe value for <code>vm.overcommit_ratio</code> when resource queue-based resource management is active, first determine the total memory available to SynxDB processes, <code>gp_vmem_rq</code>.</p>
<ul>
<li>
<p>If the total system memory is less than 256 GB, use this formula:</p>
<pre><code>gp_vmem_rq = ((SWAP + RAM) – (7.5GB + 0.05 * RAM)) / 1.7
</code></pre>
</li>
<li>
<p>If the total system memory is equal to or greater than 256 GB, use this formula:</p>
<pre><code>gp_vmem_rq = ((SWAP + RAM) – (7.5GB + 0.05 * RAM)) / 1.17
</code></pre>
</li>
</ul>
<p>where <code>SWAP</code> is the swap space on the host in GB, and <code>RAM</code> is the number of GB of RAM installed on the host.</p>
<p>When resource queue-based resource management is active, use <code>gp_vmem_rq</code> to calculate the <code>vm.overcommit_ratio</code> value with this formula:</p>
<pre><code>vm.overcommit_ratio = (RAM - 0.026 * gp_vmem_rq) / RAM
</code></pre>
<h2 id="configuring-synxdb-memory"><a class="header" href="#configuring-synxdb-memory"><a id="section_nfn_q5r_bs"></a>Configuring SynxDB Memory</a></h2>
<p>SynxDB Memory is the amount of memory available to all SynxDB segment instances.</p>
<p>When you set up the SynxDB cluster, you determine the number of primary segments to run per host and the amount of memory to allocate for each segment. Depending on the CPU cores, amount of physical RAM, and workload characteristics, the number of segments is usually a value between 4 and 8. With segment mirroring enabled, it is important to allocate memory for the maximum number of primary segments running on a host during a failure. For example, if you use the default grouping mirror configuration, a segment host failure doubles the number of acting primaries on the host that has the failed host’s mirrors. Mirror configurations that spread each host’s mirrors over multiple other hosts can lower the maximum, allowing more memory to be allocated for each segment. For example, if you use a block mirroring configuration with 4 hosts per block and 8 primary segments per host, a single host failure would cause other hosts in the block to have a maximum of 11 active primaries, compared to 16 for the default grouping mirror configuration.</p>
<p><strong>Configuring Segment Memory when Resource Group-Based Resource Management is Active</strong></p>
<p>When resource group-based resource management is active, the amount of memory allocated to each segment on a segment host is the memory available to SynxDB multiplied by the gp_resource_group_memory_limit server configuration parameter and divided by the number of active primary segments on the host. Use the following formula to calculate segment memory when using resource groups for resource management.</p>
<pre><code>
rg_perseg_mem = ((RAM * (vm.overcommit_ratio / 100) + SWAP) * gp_resource_group_memory_limit) / num_active_primary_segments
</code></pre>
<p>Resource groups expose additional configuration parameters that enable you to further control and refine the amount of memory allocated for queries.</p>
<p><strong>Configuring Segment Memory when Resource Queue-Based Resource Management is Active</strong></p>
<p>When resource queue-based resource management is active, the gp_vmem_protect_limit server configuration parameter value identifies the amount of memory to allocate to each segment. This value is estimated by calculating the memory available for all SynxDB processes and dividing by the maximum number of primary segments during a failure. If gp_vmem_protect_limit is set too high, queries can fail. Use the following formula to calculate a safe value for gp_vmem_protect_limit; provide the <code>gp_vmem_rq</code> value that you calculated earlier.</p>
<pre><code>
gp_vmem_protect_limit = gp_vmem_rq / max_acting_primary_segments
</code></pre>
<p>where <code>max_acting_primary_segments</code> is the maximum number of primary segments that could be running on a host when mirror segments are activated due to a host or segment failure.</p>
<blockquote>
<p><strong>Note</strong> The gp_vmem_protect_limit setting is enforced only when resource queue-based resource management is active in SynxDB. SynxDB ignores this configuration parameter when resource group-based resource management is active.</p>
</blockquote>
<p>Resource queues expose additional configuration parameters that enable you to further control and refine the amount of memory allocated for queries.</p>
<h2 id="example-memory-configuration-calculations"><a class="header" href="#example-memory-configuration-calculations"><a id="section_example"></a>Example Memory Configuration Calculations</a></h2>
<p>This section provides example memory calculations for resource queues and resource groups for a SynxDB system with the following specifications:</p>
<ul>
<li>Total RAM = 256GB</li>
<li>Swap = 64GB</li>
<li>8 primary segments and 8 mirror segments per host, in blocks of 4 hosts</li>
<li>Maximum number of primaries per host during failure is 11</li>
</ul>
<p><strong>Resource Group Example</strong></p>
<p>When resource group-based resource management is active in SynxDB, the usable memory available on a host is a function of the amount of RAM and swap space configured for the system, as well as the <code>vm.overcommit_ratio</code> system parameter setting:</p>
<pre><code>
total_node_usable_memory = RAM * (vm.overcommit_ratio / 100) + Swap
                         = 256GB * (50/100) + 64GB
                         = 192GB
</code></pre>
<p>Assuming the default <code>gp_resource_group_memory_limit</code> value (.7), the memory allocated to a SynxDB host with the example configuration is:</p>
<pre><code>
total_gp_memory = total_node_usable_memory * gp_resource_group_memory_limit
                = 192GB * .7
                = 134.4GB
</code></pre>
<p>The memory available to a SynxDB segment on a segment host is a function of the memory reserved for SynxDB on the host and the number of active primary segments on the host. On cluster startup:</p>
<pre><code>
gp_seg_memory = total_gp_memory / number_of_active_primary_segments
              = 134.4GB / 8
              = 16.8GB
</code></pre>
<p>Note that when 3 mirror segments switch to primary segments, the per-segment memory is still 16.8GB. Total memory usage on the segment host may approach:</p>
<pre><code>total_gp_memory_with_primaries = 16.8GB * 11 = 184.8GB
</code></pre>
<p><strong>Resource Queue Example</strong></p>
<p>The <code>vm.overcommit_ratio</code> calculation for the example system when resource queue-based resource management is active in SynxDB follows:</p>
<pre><code>
gp_vmem_rq = ((SWAP + RAM) – (7.5GB + 0.05 * RAM)) / 1.7
        = ((64 + 256) - (7.5 + 0.05 * 256)) / 1.7
        = 176

vm.overcommit_ratio = (RAM - (0.026 * gp_vmem_rq)) / RAM
                    = (256 - (0.026 * 176)) / 256
                    = .982
</code></pre>
<p>You would set <code>vm.overcommit_ratio</code> of the example system to 98.</p>
<p>The <code>gp_vmem_protect_limit</code> calculation when resource queue-based resource management is active in SynxDB:</p>
<pre><code>
gp_vmem_protect_limit = gp_vmem_rq / maximum_acting_primary_segments
                      = 176 / 11
                      = 16GB
                      = 16384MB

</code></pre>
<p>You would set the <code>gp_vmem_protect_limit</code> server configuration parameter on the example system to 16384.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../admin_guide/perf_issues.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../admin_guide/wlmgmt.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../admin_guide/perf_issues.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../admin_guide/wlmgmt.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
