<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Recovering from Segment Failures - SynxDB 2 Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SynxDB 2 Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <a href="https://www.synxdata.com/"><img id="fa fa-print" src="../../../SYNX-Text-and-Circular-Logo-142x28-White-text-Black-background.png" alt="Synx Data Labs Logo"/></a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="recovering-from-segment-failures"><a class="header" href="#recovering-from-segment-failures">Recovering from Segment Failures</a></h1>
<p>This topic walks you through what to do when one or more segments or hosts are down and you want to recover the down segments. The recovery path you follow depends primarily which of these 3 scenarios fits your circumstances:</p>
<ul>
<li>
<p>you want to recover in-place to the current host</p>
</li>
<li>
<p>you want to recover to a different host, within the cluster</p>
</li>
<li>
<p>you want to recover to a new host, outside of the cluster</p>
</li>
</ul>
<p>The steps you follow within these scenarios can vary, depending on:</p>
<ul>
<li>
<p>whether you want to do an incremental or a full recovery</p>
</li>
<li>
<p>whether you want to recover all segments or just a subset of segments</p>
</li>
</ul>
<blockquote>
<p><strong>Note</strong> Incremental recovery is only possible when recovering segments to the current host (in-place recovery).</p>
</blockquote>
<p>This topic is divided into the following sections:</p>
<ul>
<li><a href="#prepare_for_recovery">Prerequisites</a></li>
<li><a href="#recovery_scenarios">Recovery Scenarios</a></li>
<li><a href="#post_recovery">Post-Recovery Tasks</a></li>
</ul>
<h2 id="prerequisites"><a class="header" href="#prerequisites"><a id="prepare_for_recovery"></a>Prerequisites</a></h2>
<ul>
<li>Mirroring is enabled for all segments.</li>
<li>Youâ€™ve already identified which segments have failed. If necessary, see the topic <a href="g-checking-for-failed-segments.html">Checking for Failed Segments</a>.</li>
<li>The master host can connect to the segment host.</li>
<li>All networking or hardware issues that caused the segment to fail have been resolved.</li>
</ul>
<h2 id="recovery-scenarios"><a class="header" href="#recovery-scenarios"><a id="recovery_scenarios"></a>Recovery Scenarios</a></h2>
<p>This section documents the steps for the 3 distinct segment recovery scenarios. Follow the link to instructions that walk you through each scenario.</p>
<ul>
<li><a href="#same_host">Recover In-Place to Current Host</a>
<ul>
<li><a href="#incremental">Incremental Recovery</a></li>
<li><a href="#full">Full Recovery</a></li>
<li><a href="#differential">Differential Recovery</a></li>
</ul>
</li>
<li><a href="#different_host">Recover to A Different Host within the Cluster</a></li>
<li><a href="#new_host">Recover to A New Host, Outside of the Cluster</a></li>
</ul>
<h3 id="recover-in-place-to-current-host"><a class="header" href="#recover-in-place-to-current-host"><a id="same_host"></a>Recover In-Place to Current Host</a></h3>
<p>When recovering in-place to the current host, you may choose between incremental recovery (the default), full recovery, and differential recovery.</p>
<h4 id="incremental-recovery"><a class="header" href="#incremental-recovery"><a id="incremental"></a>Incremental Recovery</a></h4>
<p>Follow these steps for incremental recovery:</p>
<ol>
<li>
<p>To recover all segments, run <code>gprecoverseg</code> with no options:</p>
<pre><code>gprecoverseg
</code></pre>
</li>
<li>
<p>To recover a subset of segments:</p>
<ol>
<li>
<p>Manually create a <code>recover_config_file</code> file in a location of your choice, where each segment to recover has its own line with format <code>failedAddress|failedPort|failedDataDirectory</code> or <code>failedHostname|failedAddress|failedPort|failedDataDirectory</code></p>
<p>For multiple segments, create a new line for each segment you want to recover, specifying the hostname the address, port number and data directory for each down segment. For example:</p>
<pre><code>failedAddress1|failedPort1|failedDataDirectory1
failedAddress2|failedPort2|failedDataDirectory2
failedAddress3|failedPort3|failedDataDirectory3
</code></pre>
<p>or</p>
<pre><code>failedHostname1|failedAddress1|failedPort1|failedDataDirectory1
failedHostname2|failedAddress2|failedPort2|failedDataDirectory2
failedHostname2|failedAddress3|failedPort3|failedDataDirectory3
</code></pre>
</li>
<li>
<p>Alternatively, generate a sample recovery file using the following command; you may edit the resulting file if necessary:</p>
<pre><code>$ gprecoverseg -o /home/gpadmin/recover_config_file
</code></pre>
</li>
<li>
<p>Pass the <code>recover_config_file</code> to the <code>gprecoverseg -i</code> command:</p>
<pre><code>$ gprecoverseg -i /home/gpadmin/recover_config_file  
</code></pre>
</li>
</ol>
</li>
<li>
<p>Perform the post-recovery tasks summarized in the section <a href="#post_recovery">Post-Recovery Tasks</a>.</p>
</li>
</ol>
<h4 id="full-recovery"><a class="header" href="#full-recovery"><a id="full"></a>Full Recovery</a></h4>
<ol>
<li>
<p>To recover all segments, run <code>gprecoverseg -F</code>:</p>
<pre><code>gprecoverseg -F
</code></pre>
</li>
<li>
<p>To recover specific segments:</p>
<ol>
<li>
<p>Manually create a <code>recover_config_file</code> file in a location of your choice, where each segment to recover has its own line with following format:</p>
<pre><code>failedAddress1|failedPort1|failedDataDirectory1&lt;SPACE&gt;failedAddress2|failedPort2|failedDataDirectory2
</code></pre>
<p>or</p>
<pre><code>failedHostname1|failedAddress1|failedPort1|failedDataDirectory1&lt;SPACE&gt;failedHostname2|failedAddress2|failedPort2|failedDataDirectory2
</code></pre>
<p>Note the literal <strong>SPACE</strong> separating the lines.</p>
</li>
<li>
<p>Alternatively, generate a sample recovery file using the following command and edit the resulting file to match your desired recovery configuration:</p>
<pre><code>$ gprecoverseg -o /home/gpadmin/recover_config_file
</code></pre>
</li>
<li>
<p>Run the following command, passing in the config file generated in the previous step:</p>
<pre><code>$ gprecoverseg -i recover_config_file
</code></pre>
</li>
</ol>
</li>
<li>
<p>Perform the post-recovery tasks summarized in the section <a href="#post_recovery">Post-Recovery Tasks</a>.</p>
</li>
</ol>
<h4 id="differential-recovery"><a class="header" href="#differential-recovery"><a id="differential"></a>Differential Recovery</a></h4>
<p>Follow these steps for differential recovery:</p>
<ol>
<li>Run <code>gprecoverseg --differential</code></li>
</ol>
<h3 id="recover-to-a-different-host-within-the-cluster"><a class="header" href="#recover-to-a-different-host-within-the-cluster"><a id="different_host"></a>Recover to A Different Host within the Cluster</a></h3>
<blockquote>
<p><strong>Note</strong> Only full recovery is possible when recovering to a different host in the cluster.</p>
</blockquote>
<p>Follow these steps to recover all segments or just a subset of segments to a different host in the cluster:</p>
<ol>
<li>
<p>Manually create a <code>recover_config_file</code> file in a location of your choice, where each segment to recover has its own line with following format:</p>
<pre><code>failedAddress|failedPort|failedDataDirectory&lt;SPACE&gt;newAddress|newPort|newDataDirectory
</code></pre>
<p>or</p>
<pre><code>failedHostname|failedAddress|failedPort|failedDataDirectory&lt;SPACE&gt;newHostname|newAddress|newPort|newDataDirectory
</code></pre>
<p>Note the literal <strong>SPACE</strong> separating the details of the down segment from the details of where the segment will be recovered to.</p>
<p>Alternatively, generate a sample recovery file using the following command and edit the resulting file to match your desired recovery configuration:</p>
<pre><code>$ gprecoverseg -o -p /home/gpadmin/recover_config_file
</code></pre>
</li>
<li>
<p>Run the following command, passing in the config file generated in the previous step:</p>
<pre><code>$ gprecoverseg -i recover_config_file
</code></pre>
</li>
<li>
<p>Perform the post-recovery tasks summarized in the section <a href="#post_recovery">Post-Recovery Tasks</a>.</p>
</li>
</ol>
<h3 id="recover-to-a-new-host-outside-of-the-cluster"><a class="header" href="#recover-to-a-new-host-outside-of-the-cluster"><a id="new_host"></a>Recover to A New Host, Outside of the Cluster</a></h3>
<p>Follow these steps if you are planning to do a hardware refresh on the host the segments are running on.</p>
<blockquote>
<p><strong>Note</strong> Only full recovery is possible when recovering to a new host.</p>
</blockquote>
<h4 id="requirements-for-new-host"><a class="header" href="#requirements-for-new-host"><a id="new_host_requirements"></a>Requirements for New Host</a></h4>
<p>The new host must:</p>
<ul>
<li>
<p>have the same SynxDB software installed and configured as the failed host</p>
</li>
<li>
<p>have the same hardware and OS configuration as the failed host (same hostname, OS version, OS configuration parameters applied, locales, gpadmin user account, data directory locations created, ssh keys exchanged, number of network interfaces, network interface naming convention, and so on)</p>
</li>
<li>
<p>have sufficient disk space to accommodate the segments</p>
</li>
<li>
<p>be able to connect password-less with all other existing segments and SynxDB master.</p>
</li>
</ul>
<h4 id="steps-to-recover-to-a-new-host"><a class="header" href="#steps-to-recover-to-a-new-host"><a id="recover_to_new_host"></a>Steps to Recover to a New Host</a></h4>
<ol>
<li>
<p>Bring up the new host</p>
</li>
<li>
<p>Run the following command to recover all segments to the new host:</p>
<pre><code>gprecoverseg -p &lt;new_host_name&gt;
</code></pre>
<p>You may also specify more than one host. However, be sure you do not trigger a double-fault scenario when recovering to two hosts at a time.</p>
<pre><code>gprecoverseg -p &lt;new_host_name1&gt;,&lt;new_host_name2&gt;
</code></pre>
<blockquote>
<p><strong>Note</strong> In the case of multiple failed segment hosts, you can specify the hosts to recover to with a comma-separated list. However, it is strongly recommended to recover to one host at a time. If you must recover to more than one host at a time, then it is critical to ensure that a double fault scenario does not occur, in which both the segment primary and corresponding mirror are offline.</p>
</blockquote>
</li>
<li>
<p>Perform the post-recovery tasks summarized in the section <a href="#post_recovery">Post-Recovery Tasks</a>.</p>
</li>
</ol>
<h3 id="post-recovery-tasks"><a class="header" href="#post-recovery-tasks"><a id="post_recovery"></a>Post-Recovery Tasks</a></h3>
<p>Follow these steps once <code>gprecoverseg</code> has completed:</p>
<ol>
<li>
<p>Validate segement status and preferred roles:</p>
<pre><code>select * from gp_segment_configuration
</code></pre>
</li>
<li>
<p>Monitor mirror synchronization progress:</p>
<pre><code>gpstate -e
</code></pre>
</li>
<li>
<p>If necessary, run the following command to return segments to their preferred roles:</p>
<pre><code>gprecoverseg -r
</code></pre>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../admin_guide/highavail/topics/g-understanding-segment-recovery.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../admin_guide/highavail/topics/g-recovering-a-failed-master.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../admin_guide/highavail/topics/g-understanding-segment-recovery.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../admin_guide/highavail/topics/g-recovering-a-failed-master.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
