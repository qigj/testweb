<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PL/Perl Language - SynxDB 2 Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SynxDB 2 Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <a href="https://www.synxdata.com/"><img id="fa fa-print" src="../SYNX-Text-and-Circular-Logo-142x28-White-text-Black-background.png" alt="Synx Data Labs Logo"/></a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="plperl-language"><a class="header" href="#plperl-language">PL/Perl Language</a></h1>
<p>This chapter includes the following information:</p>
<ul>
<li><a href="#topic2">About SynxDB PL/Perl</a></li>
<li><a href="#topic3">SynxDB PL/Perl Limitations</a></li>
<li><a href="#topic31">Trusted/Untrusted Language</a></li>
<li><a href="#topic33">Developing Functions with PL/Perl</a></li>
</ul>
<h2 id="about-synxdb-plperl"><a class="header" href="#about-synxdb-plperl"><a id="topic2"></a>About SynxDB PL/Perl</a></h2>
<p>With the SynxDB PL/Perl extension, you can write user-defined functions in Perl that take advantage of its advanced string manipulation operators and functions. PL/Perl provides both trusted and untrusted variants of the language.</p>
<p>PL/Perl is embedded in your SynxDB distribution. SynxDB PL/Perl requires Perl to be installed on the system of each database host.</p>
<p>Refer to the <a href="https://www.postgresql.org/docs/9.4/plperl.html">PostgreSQL PL/Perl documentation</a> for additional information.</p>
<h2 id="synxdb-plperl-limitations"><a class="header" href="#synxdb-plperl-limitations"><a id="topic3"></a>SynxDB PL/Perl Limitations</a></h2>
<p>Limitations of the SynxDB PL/Perl language include:</p>
<ul>
<li>SynxDB does not support PL/Perl triggers.</li>
<li>PL/Perl functions cannot call each other directly.</li>
<li>SPI is not yet fully implemented.</li>
<li>If you fetch very large data sets using <code>spi_exec_query()</code>, you should be aware that these will all go into memory. You can avoid this problem by using <code>spi_query()/spi_fetchrow()</code>. A similar problem occurs if a set-returning function passes a large set of rows back to SynxDB via a <code>return</code> statement. Use <code>return_next</code> for each row returned to avoid this problem.</li>
<li>When a session ends normally, not due to a fatal error, PL/Perl runs any <code>END</code> blocks that you have defined. No other actions are currently performed. (File handles are not automatically flushed and objects are not automatically destroyed.)</li>
</ul>
<h2 id="trusteduntrusted-language"><a class="header" href="#trusteduntrusted-language"><a id="topic31"></a>Trusted/Untrusted Language</a></h2>
<p>PL/Perl includes trusted and untrusted language variants.</p>
<p>The PL/Perl trusted language is named <code>plperl</code>. The trusted PL/Perl language restricts file system operations, as well as <code>require</code>, <code>use</code>, and other statements that could potentially interact with the operating system or database server process. With these restrictions in place, any SynxDB user can create and run functions in the trusted <code>plperl</code> language.</p>
<p>The PL/Perl untrusted language is named <code>plperlu</code>. You cannot restrict the operation of functions you create with the <code>plperlu</code> untrusted language. Only database superusers have privileges to create untrusted PL/Perl user-defined functions. And only database superusers and other database users that are explicitly granted the permissions can run untrusted PL/Perl user-defined functions.</p>
<p>PL/Perl has limitations with respect to communication between interpreters and the number of interpreters running in a single process. Refer to the PostgreSQL <a href="https://www.postgresql.org/docs/9.4/plperl-trusted.html">Trusted and Untrusted PL/Perl</a> documentation for additional information.</p>
<h2 id="enabling-and-removing-plperl-support"><a class="header" href="#enabling-and-removing-plperl-support"><a id="topic6"></a>Enabling and Removing PL/Perl Support</a></h2>
<p>You must register the PL/Perl language with a database before you can create and run a PL/Perl user-defined function within that database. To remove PL/Perl support, you must explicitly remove the extension from each database in which it was registered. You must be a database superuser or owner to register or remove trusted languages in SynxDBs.</p>
<blockquote>
<p><strong>Note</strong> Only database superusers may register or remove support for the <em>untrusted</em> PL/Perl language <code>plperlu</code>.</p>
</blockquote>
<p>Before you enable or remove PL/Perl support in a database, ensure that:</p>
<ul>
<li>Your SynxDB is running.</li>
<li>You have sourced <code>synxdb_path.sh</code>.</li>
<li>You have set the <code>$MASTER_DATA_DIRECTORY</code> and <code>$GPHOME</code> environment variables.</li>
</ul>
<h3 id="enabling-plperl-support"><a class="header" href="#enabling-plperl-support"><a id="topic61"></a>Enabling PL/Perl Support</a></h3>
<p>For each database in which you want to enable PL/Perl, register the language using the SQL <a href="../ref_guide/sql_commands/CREATE_EXTENSION.html">CREATE EXTENSION</a> command. For example, run the following command as the <code>gpadmin</code> user to register the trusted PL/Perl language for the database named <code>testdb</code>:</p>
<pre><code>$ psql -d testdb -c 'CREATE EXTENSION plperl;'
</code></pre>
<h3 id="removing-plperl-support"><a class="header" href="#removing-plperl-support"><a id="topic62"></a>Removing PL/Perl Support</a></h3>
<p>To remove support for PL/Perl from a database, run the SQL <a href="../ref_guide/sql_commands/DROP_EXTENSION.html">DROP EXTENSION</a> command. For example, run the following command as the <code>gpadmin</code> user to remove support for the trusted PL/Perl language from the database named <code>testdb</code>:</p>
<pre><code>$ psql -d testdb -c 'DROP EXTENSION plperl;'
</code></pre>
<p>The default command fails if any existing objects (such as functions) depend on the language. Specify the <code>CASCADE</code> option to also drop all dependent objects, including functions that you created with PL/Perl.</p>
<h2 id="developing-functions-with-plperl"><a class="header" href="#developing-functions-with-plperl"><a id="topic33"></a>Developing Functions with PL/Perl</a></h2>
<p>You define a PL/Perl function using the standard SQL <a href="../ref_guide/sql_commands/CREATE_FUNCTION.html">CREATE FUNCTION</a> syntax. The body of a PL/Perl user-defined function is ordinary Perl code. The PL/Perl interpreter wraps this code inside a Perl subroutine.</p>
<p>You can also create an anonymous code block with PL/Perl. An anonymous code block, called with the SQL <a href="../ref_guide/sql_commands/DO.html">DO</a> command, receives no arguments, and whatever value it might return is discarded. Otherwise, a PL/Perl anonymous code block behaves just like a function. Only database superusers create an anonymous code block with the untrusted <code>plperlu</code> language.</p>
<p>The syntax of the <code>CREATE FUNCTION</code> command requires that you write the PL/Perl function body as a string constant. While it is more convenient to use dollar-quoting, you can choose to use escape string syntax (<code>E''</code>) provided that you double any single quote marks and backslashes used in the body of the function.</p>
<p>PL/Perl arguments and results are handled as they are in Perl. Arguments you pass in to a PL/Perl function are accessed via the <code>@_</code> array. You return a result value with the <code>return</code> statement, or as the last expression evaluated in the function. A PL/Perl function cannot directly return a non-scalar type because you call it in a scalar context. You can return non-scalar types such as arrays, records, and sets in a PL/Perl function by returning a reference.</p>
<p>PL/Perl treats null argument values as “undefined”. Adding the <code>STRICT</code> keyword to the <code>LANGUAGE</code> subclause instructs SynxDB to immediately return null when any of the input arguments are null. When created as <code>STRICT</code>, the function itself need not perform null checks.</p>
<p>The following PL/Perl function utilizes the <code>STRICT</code> keyword to return the greater of two integers, or null if any of the inputs are null:</p>
<pre><code>
CREATE FUNCTION perl_max (integer, integer) RETURNS integer AS $$
    if ($_[0] &gt; $_[1]) { return $_[0]; }
    return $_[1];
$$ LANGUAGE plperl STRICT;

SELECT perl_max( 1, 3 );
 perl_max
----------
        3
(1 row)

SELECT perl_max( 1, null );
 perl_max
----------

(1 row)

</code></pre>
<p>PL/Perl considers anything in a function argument that is not a reference to be a string, the standard SynxDB external text representation. The argument values supplied to a PL/Perl function are simply the input arguments converted to text form (just as if they had been displayed by a <code>SELECT</code> statement). In cases where the function argument is not an ordinary numeric or text type, you must convert the SynxDB type to a form that is more usable by Perl. Conversely, the <code>return</code> and <code>return_next</code> statements accept any string that is an acceptable input format for the function’s declared return type.</p>
<p>Refer to the PostgreSQL <a href="https://www.postgresql.org/docs/9.4/plperl-funcs.html">PL/Perl Functions and Arguments</a> documentation for additional information, including composite type and result set manipulation.</p>
<h3 id="built-in-plperl-functions"><a class="header" href="#built-in-plperl-functions"><a id="topic3311"></a>Built-in PL/Perl Functions</a></h3>
<p>PL/Perl includes built-in functions to access the database, including those to prepare and perform queries and manipulate query results. The language also includes utility functions for error logging and string manipulation.</p>
<p>The following example creates a simple table with an integer and a text column. It creates a PL/Perl user-defined function that takes an input string argument and invokes the <code>spi_exec_query()</code> built-in function to select all columns and rows of the table. The function returns all rows in the query results where the <code>v</code> column includes the function input string.</p>
<pre><code>
CREATE TABLE test (
    i int,
    v varchar
);
INSERT INTO test (i, v) VALUES (1, 'first line');
INSERT INTO test (i, v) VALUES (2, 'line2');
INSERT INTO test (i, v) VALUES (3, '3rd line');
INSERT INTO test (i, v) VALUES (4, 'different');

CREATE OR REPLACE FUNCTION return_match(varchar) RETURNS SETOF test AS $$
    # store the input argument
    $ss = $_[0];

    # run the query
    my $rv = spi_exec_query('select i, v from test;');

    # retrieve the query status
    my $status = $rv-&gt;{status};

    # retrieve the number of rows returned in the query
    my $nrows = $rv-&gt;{processed};

    # loop through all rows, comparing column v value with input argument
    foreach my $rn (0 .. $nrows - 1) {
        my $row = $rv-&gt;{rows}[$rn];
        my $textstr = $row-&gt;{v};
        if( index($textstr, $ss) != -1 ) {
            # match!  return the row.
            return_next($row);
        }
    }
    return undef;
$$ LANGUAGE plperl EXECUTE ON MASTER ;

SELECT return_match( 'iff' );
 return_match
---------------
 (4,different)
(1 row)

</code></pre>
<p>Refer to the PostgreSQL PL/Perl <a href="https://www.postgresql.org/docs/9.4/plperl-builtins.html">Built-in Functions</a> documentation for a detailed discussion of available functions.</p>
<h3 id="global-values-in-plperl"><a class="header" href="#global-values-in-plperl"><a id="topic331"></a>Global Values in PL/Perl</a></h3>
<p>You can use the global hash map <code>%_SHARED</code> to share data, including code references, between PL/Perl function calls for the lifetime of the current session.</p>
<p>The following example uses <code>%_SHARED</code> to share data between the user-defined <code>set_var()</code> and <code>get_var()</code> PL/Perl functions:</p>
<pre><code>
CREATE OR REPLACE FUNCTION set_var(name text, val text) RETURNS text AS $$
    if ($_SHARED{$_[0]} = $_[1]) {
        return 'ok';
    } else {
        return "cannot set shared variable $_[0] to $_[1]";
    }
$$ LANGUAGE plperl;

CREATE OR REPLACE FUNCTION get_var(name text) RETURNS text AS $$
    return $_SHARED{$_[0]};
$$ LANGUAGE plperl;

SELECT set_var('key1', 'value1');
 set_var
---------
 ok
(1 row)

SELECT get_var('key1');
 get_var
---------
 value1
(1 row)

</code></pre>
<p>For security reasons, PL/Perl creates a separate Perl interpreter for each role. This prevents accidental or malicious interference by one user with the behavior of another user’s PL/Perl functions. Each such interpreter retains its own value of the <code>%_SHARED</code> variable and other global state. Two PL/Perl functions share the same value of <code>%_SHARED</code> if and only if they are run by the same SQL role.</p>
<p>There are situations where you must take explicit steps to ensure that PL/Perl functions can share data in <code>%_SHARED</code>. For example, if an application runs under multiple SQL roles (via <code>SECURITY DEFINER</code> functions, use of <code>SET ROLE</code>, etc.) in a single session, make sure that functions that need to communicate are owned by the same user, and mark these functions as <code>SECURITY DEFINER</code>.</p>
<h3 id="notes"><a class="header" href="#notes"><a id="topic335"></a>Notes</a></h3>
<p>Additional considerations when developing PL/Perl functions:</p>
<ul>
<li>PL/Perl internally utilizes the UTF-8 encoding. It converts any arguments provided in other encodings to UTF-8, and converts return values from UTF-8 back to the original encoding.</li>
<li>Nesting named PL/Perl subroutines retains the same dangers as in Perl.</li>
<li>Only the untrusted PL/Perl language variant supports module import. Use <code>plperlu</code> with care.</li>
<li>Any module that you use in a <code>plperlu</code> function must be available from the same location on all SynxDB hosts.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../analytics/pl_java.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../analytics/pl_sql.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../analytics/pl_java.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../analytics/pl_sql.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
