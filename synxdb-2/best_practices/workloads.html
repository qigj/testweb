<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Memory and Resource Management with Resource Queues - SynxDB 2 Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SynxDB 2 Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <a href="https://www.synxdata.com/"><img id="fa fa-print" src="../SYNX-Text-and-Circular-Logo-142x28-White-text-Black-background.png" alt="Synx Data Labs Logo"/></a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="memory-and-resource-management-with-resource-queues"><a class="header" href="#memory-and-resource-management-with-resource-queues">Memory and Resource Management with Resource Queues</a></h1>
<p>Avoid memory errors and manage SynxDB resources.</p>
<blockquote>
<p><strong>Note</strong> Resource groups are a newer resource management scheme that enforces memory, CPU, and concurrent transaction limits in SynxDB. The <a href="../admin_guide/wlmgmt.html">Managing Resources</a> topic provides a comparison of the resource queue and the resource group management schemes. Refer to <a href="../admin_guide/workload_mgmt_resgroups.html">Using Resource Groups</a> for configuration and usage information for this resource management scheme.</p>
</blockquote>
<p>Memory management has a significant impact on performance in a SynxDB cluster. The default settings are suitable for most environments. Do not change the default settings until you understand the memory characteristics and usage on your system.</p>
<ul>
<li><a href="#section_jqw_qbl_zt">Resolving Out of Memory Errors</a></li>
<li><a href="#section113x">Low Memory Queries</a></li>
<li><a href="#section_r52_rbl_zt">Configuring Memory for SynxDB</a></li>
<li><a href="#configuring_rq">Configuring Resource Queues</a></li>
</ul>
<h2 id="resolving-out-of-memory-errors"><a class="header" href="#resolving-out-of-memory-errors"><a id="section_jqw_qbl_zt"></a>Resolving Out of Memory Errors</a></h2>
<p>An out of memory error message identifies the SynxDB segment, host, and process that experienced the out of memory error. For example:</p>
<pre><code>Out of memory (seg27 host.example.com pid=47093)
VM Protect failed to allocate 4096 bytes, 0 MB available
</code></pre>
<p>Some common causes of out-of-memory conditions in SynxDB are:</p>
<ul>
<li>Insufficient system memory (RAM) available on the cluster</li>
<li>Improperly configured memory parameters</li>
<li>Data skew at the segment level</li>
<li>Operational skew at the query level</li>
</ul>
<p>Following are possible solutions to out of memory conditions:</p>
<ul>
<li>Tune the query to require less memory</li>
<li>Reduce query concurrency using a resource queue</li>
<li>Validate the <code>gp_vmem_protect_limit</code> configuration parameter at the database level. See calculations for the maximum safe setting in <a href="#section_r52_rbl_zt">Configuring Memory for SynxDB</a>.</li>
<li>Set the memory quota on a resource queue to limit the memory used by queries run within the resource queue</li>
<li>Use a session setting to reduce the <code>statement_mem</code> used by specific queries</li>
<li>Decrease <code>statement_mem</code> at the database level</li>
<li>Decrease the number of segments per host in the SynxDB cluster. This solution requires a re-initializing SynxDB and reloading your data.</li>
<li>Increase memory on the host, if possible. (Additional hardware may be required.)</li>
</ul>
<p>Adding segment hosts to the cluster will not in itself alleviate out of memory problems. The memory used by each query is determined by the <code>statement_mem</code> parameter and it is set when the query is invoked. However, if adding more hosts allows decreasing the number of segments per host, then the amount of memory allocated in <code>gp_vmem_protect_limit</code> can be raised.</p>
<h2 id="low-memory-queries"><a class="header" href="#low-memory-queries"><a id="section113x"></a>Low Memory Queries</a></h2>
<p>A low <code>statement_mem</code> setting (for example, in the 1-3MB range) has been shown to increase the performance of queries with low memory requirements. Use the <code>statement_mem</code> server configuration parameter to override the setting on a per-query basis. For example:</p>
<pre><code>SET statement_mem='2MB';
</code></pre>
<h2 id="configuring-memory-for-synxdb"><a class="header" href="#configuring-memory-for-synxdb"><a id="section_r52_rbl_zt"></a>Configuring Memory for SynxDB</a></h2>
<p>Most out of memory conditions can be avoided if memory is thoughtfully managed.</p>
<p>It is not always possible to increase system memory, but you can prevent out-of-memory conditions by configuring memory use correctly and setting up resource queues to manage expected workloads.</p>
<p>It is important to include memory requirements for mirror segments that become primary segments during a failure to ensure that the cluster can continue when primary segments or segment hosts fail.</p>
<p>The following are recommended operating system and SynxDB memory settings:</p>
<ul>
<li>
<p>Do not configure the OS to use huge pages.</p>
</li>
<li>
<p><strong>vm.overcommit_memory</strong></p>
<p>This is a Linux kernel parameter, set in <code>/etc/sysctl.conf</code> and it should always be set to 2. It determines the method the OS uses for determining how much memory can be allocated to processes and 2 is the only safe setting for SynxDB. Please review the sysctl parameters in the <a href="../install_guide/prep_os.html">installation documentation</a>.</p>
</li>
<li>
<p><strong>vm.overcommit_ratio</strong></p>
<p>This is a Linux kernel parameter, set in <a href="../install_guide/prep_os.html"><code>/etc/sysctl.conf</code></a>. It is the percentage of RAM that is used for application processes. The remainder is reserved for the operating system. The default on Red Hat is 50.</p>
<p>Setting <code>vm.overcommit_ratio</code> too high may result in not enough memory being reserved for the operating system, which can result in segment host failure or database failure. Setting the value too low reduces the amount of concurrency and query complexity that can be run by reducing the amount of memory available to SynxDB. When increasing the setting it is important to remember to always reserve some memory for operating system activities.</p>
<p>See <a href="../admin_guide/wlmgmt_intro.html">SynxDB Memory Overview</a> for instructions to calculate a value for <code>vm.overcommit_ratio</code>.</p>
</li>
<li>
<p><strong>gp_vmem_protect_limit</strong></p>
<p>Use <code>gp_vmem_protect_limit</code> to set the maximum memory that the instance can allocate for <em>all</em> work being done in each segment database. Never set this value larger than the physical RAM on the system. If <code>gp_vmem_protect_limit</code> is too high, it is possible for memory to become exhausted on the system and normal operations may fail, causing segment failures. If <code>gp_vmem_protect_limit</code> is set to a safe lower value, true memory exhaustion on the system is prevented; queries may fail for hitting the limit, but system disruption and segment failures are avoided, which is the desired behavior.</p>
<p>See <a href="sysconfig.html#segment_mem_config">Resource Queue Segment Memory Configuration</a> for instructions to calculate a safe value for <code>gp_vmem_protect_limit</code>.</p>
</li>
<li>
<p><strong>runaway_detector_activation_percent</strong></p>
<p>Runaway Query Termination, introduced in SynxDB 4.3.4, prevents out of memory conditions. The <code>runaway_detector_activation_percent</code> system parameter controls the percentage of <code>gp_vmem_protect_limit</code> memory utilized that triggers termination of queries. It is set on by default at 90%. If the percentage of <code>gp_vmem_protect_limit</code> memory that is utilized for a segment exceeds the specified value, SynxDB terminates queries based on memory usage, beginning with the query consuming the largest amount of memory. Queries are terminated until the utilized percentage of <code>gp_vmem_protect_limit</code> is below the specified percentage.</p>
</li>
<li>
<p><strong>statement_mem</strong></p>
<p>Use <code>statement_mem</code> to allocate memory used for a query per segment database. If additional memory is required it will spill to disk. Set the optimal value for <code>statement_mem</code> as follows:</p>
<pre><code>(vmprotect * .9) / max_expected_concurrent_queries
</code></pre>
<p>The default value of <code>statement_mem</code> is 125MB. For example, on a system that is configured with 8 segments per host, a query uses 1GB of memory on each segment server (8 segments ⨉ 125MB) with the default <code>statement_mem</code> setting. Set <code>statement_mem</code> at the session level for specific queries that require additional memory to complete. This setting works well to manage query memory on clusters with low concurrency. For clusters with high concurrency also use resource queues to provide additional control on what and how much is running on the system.</p>
</li>
<li>
<p><strong>gp_workfile_limit_files_per_query</strong></p>
<p>Set <code>gp_workfile_limit_files_per_query</code> to limit the maximum number of temporary spill files (workfiles) allowed per query. Spill files are created when a query requires more memory than it is allocated. When the limit is exceeded the query is terminated. The default is zero, which allows an unlimited number of spill files and may fill up the file system.</p>
</li>
<li>
<p><strong>gp_workfile_compression</strong></p>
<p>If there are numerous spill files then set <code>gp_workfile_compression</code> to compress the spill files. Compressing spill files may help to avoid overloading the disk subsystem with IO operations.</p>
</li>
</ul>
<h2 id="configuring-resource-queues"><a class="header" href="#configuring-resource-queues"><a id="configuring_rq"></a>Configuring Resource Queues</a></h2>
<p>SynxDB resource queues provide a powerful mechanism for managing the workload of the cluster. Queues can be used to limit both the numbers of active queries and the amount of memory that can be used by queries in the queue. When a query is submitted to SynxDB, it is added to a resource queue, which determines if the query should be accepted and when the resources are available to run it.</p>
<ul>
<li>
<p>Associate all roles with an administrator-defined resource queue.</p>
<p>Each login user (role) is associated with a single resource queue; any query the user submits is handled by the associated resource queue. If a queue is not explicitly assigned the user’s queries are handed by the default queue, <code>pg_default</code>.</p>
</li>
<li>
<p>Do not run queries with the gpadmin role or other superuser roles.</p>
<p>Superusers are exempt from resource queue limits, therefore superuser queries always run regardless of the limits set on their assigned queue.</p>
</li>
<li>
<p>Use the <code>ACTIVE_STATEMENTS</code> resource queue parameter to limit the number of active queries that members of a particular queue can run concurrently.</p>
</li>
<li>
<p>Use the <code>MEMORY_LIMIT</code> parameter to control the total amount of memory that queries running through the queue can utilize. By combining the <code>ACTIVE_STATEMENTS</code> and <code>MEMORY_LIMIT</code> attributes an administrator can fully control the activity emitted from a given resource queue.</p>
<p>The allocation works as follows: Suppose a resource queue, <code>sample_queue</code>, has <code>ACTIVE_STATEMENTS</code> set to 10 and <code>MEMORY_LIMIT</code> set to 2000MB. This limits the queue to approximately 2 gigabytes of memory per segment. For a cluster with 8 segments per server, the total usage per server is 16 GB for <code>sample_queue</code> (2GB * 8 segments/server). If a segment server has 64GB of RAM, there could be no more than four of this type of resource queue on the system before there is a chance of running out of memory (4 queues * 16GB per queue).</p>
<p>Note that by using <code>STATEMENT_MEM</code>, individual queries running in the queue can allocate more than their “share” of memory, thus reducing the memory available for other queries in the queue.</p>
</li>
<li>
<p>Resource queue priorities can be used to align workloads with desired outcomes. Queues with <code>MAX</code> priority throttle activity in all other queues until the <code>MAX</code> queue completes running all queries.</p>
</li>
<li>
<p>Alter resource queues dynamically to match the real requirements of the queue for the workload and time of day. You can script an operational flow that changes based on the time of day and type of usage of the system and add <code>crontab</code> entries to run the scripts.</p>
</li>
<li>
<p>Use gptoolkit to view resource queue usage and to understand how the queues are working.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../best_practices/resgroups.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../best_practices/maintenance.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../best_practices/resgroups.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../best_practices/maintenance.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
